<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhatsApp Bot Control Panel</title>
    <link
      data-default-icon="https://static.whatsapp.net/rsrc.php/v4/yP/r/rYZqPCBaG70.png"
      rel="shortcut icon"
      href="https://static.whatsapp.net/rsrc.php/v4/yP/r/rYZqPCBaG70.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="192x192"
      href="https://static.whatsapp.net/rsrc.php/v4/yc/r/hUUuVTz6ZVi.png"
    />
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <!-- ç¨‹å¼ç¢¼æœå°‹åŠŸèƒ½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/jump-to-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.css"
    />

    <!-- ç¨‹å¼ç¢¼æ‘ºç–ŠåŠŸèƒ½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/comment-fold.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css"
    />

    <!-- ç¨‹å¼ç¢¼æç¤ºå’Œè‡ªå‹•å®Œæˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/javascript-hint.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css"
    />

    <!-- æ‹¬è™ŸåŒ¹é…å’Œè‡ªå‹•é—œé–‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>

    <!-- ç¨‹å¼ç¢¼è¨»è§£åŠŸèƒ½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/comment/comment.min.js"></script>

    <!-- ä»£ç¢¼æª¢æŸ¥ (linting) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.5/jshint.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.css"
    />

    <!-- æ´»å‹•è¡Œé«˜äº® -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>

    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
    <style>
      :root {
        --primary: #4caf50;
        --primary-light: #81c784;
        --primary-dark: #388e3c;
        --secondary: #66bb6a;
        --error: #f44336;
        --success: #2e7d32;
        --background: #f1f8e9;
        --surface: #ffffff;
        --text-primary: rgba(0, 0, 0, 0.87);
        --text-secondary: rgba(0, 0, 0, 0.6);
        --border-radius: 8px;
        --spacing: 8px;
        --border-color: #e0e0e0;
        --input-bg: #fff;
        --input-border: #c8e6c9;
        --tag-bg: #e8f5e9;
        --tag-color: #388e3c;
      }

      :root[data-theme="dark"] {
        --primary: #81c784;
        --primary-light: #a5d6a7;
        --primary-dark: #519657;
        --secondary: #66bb6a;
        --error: #ef5350;
        --success: #66bb6a;
        --background: #121212;
        --surface: #1e1e1e;
        --text-primary: rgba(255, 255, 255, 0.87);
        --text-secondary: rgba(255, 255, 255, 0.6);
        --border-color: rgba(255, 255, 255, 0.1);
        --input-bg: #2c2c2c;
        --input-border: rgba(255, 255, 255, 0.2);
        --tag-bg: rgba(129, 199, 132, 0.2);
        --tag-color: #a5d6a7;
      }

      @keyframes qr-spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes loading-dots {
        0% {
          content: ".";
        }
        33% {
          content: "..";
        }
        66% {
          content: "...";
        }
        100% {
          content: "";
        }
      }

      .loading-text .loading-dots {
        display: inline-block;
        animation: loading-dots 1.5s infinite steps(1);
        min-width: 24px;
        text-align: left;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Roboto", sans-serif;
      }

      .cm-toolbar {
        display: flex;
        align-items: center;
        background: var(--surface);
        border: 1px solid var(--border-color);
        border-bottom: none;
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
        padding: 4px 8px;
      }

      .cm-btn {
        background: transparent;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        margin-right: 4px;
        transition: background-color 0.2s;
      }

      .cm-btn:hover {
        background: var(--hover-bg, rgba(0, 0, 0, 0.08));
      }

      :root[data-theme="dark"] .cm-btn {
        color: var(--text-primary);
      }

      :root[data-theme="dark"] .cm-btn:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      .cm-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 16px;
        border-radius: 4px;
        background: #333;
        color: white;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        transform: translateY(100px);
        opacity: 0;
        transition: transform 0.3s, opacity 0.3s;
      }

      .cm-notification.show {
        transform: translateY(0);
        opacity: 1;
      }

      .cm-notification.success {
        background: var(--success);
      }

      .cm-notification.error {
        background: var(--error);
      }

      /* èª¿æ•´ CodeMirror é‚Šæ¡†ï¼Œè®“ toolbar åˆç†æ•´åˆ */
      .cm-toolbar + .CodeMirror {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
      }

      .CodeMirror {
        resize: both;
        overflow: none;
        min-height: 120px;
        min-width: 200px;
        border: 1px solid var(--input-border);
        border-radius: var(--border-radius);
        max-height: 600px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: border-color 0.2s;
      }

      .CodeMirror:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
      }

      :root[data-theme="dark"] .CodeMirror {
        background-color: var(--input-bg);
        color: var(--text-primary);
        border-color: var(--input-border);
      }

      :root[data-theme="dark"] .CodeMirror-gutters {
        background-color: #1e1e1e;
        border-color: #2c2c2c;
      }

      :root[data-theme="dark"] .CodeMirror-cursor {
        border-color: #fff;
      }

      :root[data-theme="dark"] .cm-s-material.CodeMirror {
        background-color: var(--input-bg);
        color: var(--text-primary);
      }

      body {
        background-color: var(--background);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
      }

      .nav {
        width: 280px;
        background: var(--surface);
        height: 100vh;
        position: fixed;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
        z-index: 1;
      }

      .nav-logo {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid rgba(0, 0, 0, 0.12);
        margin-bottom: var(--spacing);
      }

      .nav-item {
        padding: 12px 16px;
        margin: 4px 12px;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-item:hover {
        background: rgba(76, 175, 80, 0.08);
      }

      .nav-item.active {
        background: rgba(76, 175, 80, 0.12);
        color: var(--primary);
      }

      .main-content {
        margin-left: 280px;
        padding: 24px;
        flex-grow: 1;
      }

      .section {
        display: none;
        background: var(--surface);
        border-radius: var(--border-radius);
        padding: 24px;
        margin: 16px 0;
        box-shadow: 0 2px 12px rgba(76, 175, 80, 0.08);
      }

      .section.active {
        display: block;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid rgba(76, 175, 80, 0.23);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: border-color 0.2s;
        margin: 8px 0;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
      }

      /* ç¯„æœ¬æŒ‰éˆ•å’Œæ¨¡æ…‹çª—å£æ¨£å¼ */
      .template-btn {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 4px;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      }

      .template-btn:hover {
        background: #303f9f;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.18);
      }

      #template-modal .close-btn {
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
        font-size: 24px;
        line-height: 1;
      }

      #template-modal .close-btn:hover {
        opacity: 1;
      }

      .template-form {
        background: var(--background);
        padding: 16px;
        border-radius: 8px;
      }

      .template-form label .required {
        color: #f44336;
        font-weight: bold;
        margin-left: 4px;
      }

      .template-form label .optional {
        color: #9e9e9e;
        margin-left: 4px;
        font-size: 0.9em;
        font-style: italic;
      }

      .template-form input,
      .template-form textarea {
        background: #fff;
        border: 1px solid #e0e0e0;
      }

      .template-form input:focus,
      .template-form textarea:focus {
        border-color: #3f51b5;
        box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.1);
      }

      .btn {
        padding: 10px 24px;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
        min-width: 64px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
        box-shadow: 0 2px 12px rgba(76, 175, 80, 0.2);
      }

      .btn-danger {
        background: var(--error);
        color: white;
      }

      .list-item {
        padding: 16px;
        border: 1px solid rgba(76, 175, 80, 0.12);
        border-radius: var(--border-radius);
        margin: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
      }

      .list-item:hover {
        box-shadow: 0 2px 12px rgba(76, 175, 80, 0.08);
        border-color: var(--primary-light);
      }

      .status {
        padding: 8px 20px;
        border-radius: 20px;
        display: inline-block;
        margin: 16px 0;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .status.online {
        background: rgba(76, 175, 80, 0.12);
        color: var(--success);
      }

      .status.offline {
        background: rgba(244, 67, 54, 0.12);
        color: var(--error);
      }

      #console-logs {
        background: #1b5e20;
        color: #ffffff;
        font-family: "Roboto Mono", monospace;
        font-size: 0.875rem;
        height: 400px;
        overflow-y: auto;
        padding: 16px;
        border-radius: var(--border-radius);
      }

      .error-message {
        position: fixed;
        top: 24px;
        right: 24px;
        background: var(--error);
        color: white;
        padding: 16px;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
        z-index: 1000;
        display: none;
      }

      .multi-select-section {
        border: 1px solid rgba(76, 175, 80, 0.12);
        border-radius: var(--border-radius);
        padding: 20px;
        margin: 16px 0;
        background: rgba(76, 175, 80, 0.02);
      }

      .multi-select-section h4 {
        margin-bottom: 12px;
        color: var(--primary);
        font-weight: 500;
      }

      .multi-select-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 4px 0;
        border-radius: var(--border-radius);
        transition: all 0.2s ease;
      }

      .multi-select-item:hover {
        background: rgba(76, 175, 80, 0.08);
      }

      .multi-select-item input[type="checkbox"] {
        margin-right: 12px;
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .trigger-conditions {
        background: rgba(76, 175, 80, 0.02);
        border-radius: var(--border-radius);
        padding: 24px;
        margin: 16px 0;
        border: 1px solid rgba(76, 175, 80, 0.12);
      }

      .trigger-conditions input[type="text"] {
        margin-bottom: 16px;
      }

      .trigger-conditions .checkbox-group {
        display: flex;
        gap: 24px;
        margin-bottom: 16px;
        align-items: center;
      }

      .trigger-conditions label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: var(--border-radius);
        transition: background-color 0.2s;
      }

      .trigger-conditions label:hover {
        background: rgba(76, 175, 80, 0.08);
      }

      #current-triggers {
        margin-top: 16px;
      }

      .trigger-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--surface);
        border-radius: var(--border-radius);
        margin: 8px 0;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.08);
        border: 1px solid rgba(76, 175, 80, 0.12);
      }

      .trigger-item button {
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      .nav-bottom-actions-floating {
        position: fixed;
        left: 18px;
        bottom: 18px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }

      .nav-action-btn {
        width: 180px;
        padding: 8px 0;
        font-size: 0.98rem;
        border: none;
        border-radius: 5px;
        background: var(--primary-light);
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 1px 4px rgba(76, 175, 80, 0.1);
        transition: background 0.2s, box-shadow 0.2s, color 0.2s;
        cursor: pointer;
      }

      .nav-action-btn:hover {
        background: var(--primary);
        color: #fff;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.18);
      }

      .update-btn {
        background: var(--primary-dark);
        color: #fff;
      }

      .update-btn:hover {
        background: #256029;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
        margin-right: 8px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      }

      input:checked + .slider {
        background-color: var(--primary);
      }

      input:checked + .slider:before {
        transform: translateX(20px);
      }

      .switch-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.98rem;
        color: var(--text-secondary);
        margin-right: 18px;
        user-select: none;
      }

      .switch input:focus + .slider {
        outline: none;
        box-shadow: none;
      }

      .switch input:active + .slider {
        outline: none;
        box-shadow: none;
      }

      /* Modal ç¾åŒ– */
      #target-modal .modal-content {
        background: #fff;
        padding: 28px 24px 20px 24px;
        border-radius: 14px;
        min-width: 340px;
        max-width: 96vw;
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 8px 32px rgba(76, 175, 80, 0.18);
      }
      #target-modal .modal-tab {
        border: none;
        background: #f1f8e9;
        color: #388e3c;
        font-weight: 600;
        font-size: 1.05em;
        padding: 7px 22px;
        border-radius: 18px 18px 0 0;
        margin-right: 4px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
        outline: none;
      }
      #target-modal .modal-tab.active {
        background: var(--primary);
        color: #fff;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
      }
      #target-modal #target-search {
        border-radius: 18px;
        border: 1.5px solid #c8e6c9;
        padding: 7px 16px;
        font-size: 1em;
        margin-left: 8px;
        background: #f9fbe7;
        transition: border 0.2s;
      }
      #target-modal #target-search:focus {
        border: 1.5px solid var(--primary);
        background: #fff;
      }
      #target-modal #modal-list {
        margin-top: 6px;
        border-radius: 8px;
        background: #f7faf7;
        border: 1px solid #e0e0e0;
        padding: 4px 0;
      }
      #target-modal #modal-list label {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        cursor: pointer;
        border-bottom: 1px solid #e0e0e0;
        font-size: 1.04em;
        transition: background 0.18s;
      }
      #target-modal #modal-list label:last-child {
        border-bottom: none;
      }
      #target-modal #modal-list label:hover {
        background: #e8f5e9;
      }
      #target-modal #modal-list input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
        margin-right: 2px;
      }
      #target-modal #modal-selected-tags {
        margin-bottom: 10px;
        min-height: 24px;
      }
      #target-modal .tag {
        background: #e8f5e9;
        color: #388e3c;
        padding: 2px 12px;
        border-radius: 12px;
        font-size: 0.97em;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-right: 4px;
        margin-bottom: 4px;
      }
      #target-modal .btn {
        min-width: 90px;
        font-size: 1em;
        border-radius: 8px;
        margin-left: 8px;
        padding: 8px 0;
      }
      #target-modal .btn-primary {
        background: var(--primary);
        color: #fff;
      }
      #target-modal .btn-primary:hover {
        background: #256029;
      }
      #target-modal .btn-danger {
        background: #f44336;
        color: #fff;
      }
      #target-modal .btn-danger:hover {
        background: #b71c1c;
      }

      :root[data-theme="dark"] #target-modal .modal-content {
        background: var(--surface);
        color: var(--text-primary);
      }

      :root[data-theme="dark"] #target-modal #modal-list {
        background: var(--surface);
        border-color: var(--border-color);
      }

      :root[data-theme="dark"] #target-modal #modal-list label {
        border-color: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
      }

      :root[data-theme="dark"] #target-modal #modal-list label:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      :root[data-theme="dark"] #target-modal #target-search {
        background: var(--input-bg);
        color: var(--text-primary);
        border-color: var(--input-border);
      }

      :root[data-theme="dark"] .tag {
        background: var(--tag-bg);
        color: var(--tag-color);
      }
    </style>
  </head>
  <body>
    <div id="error-message" class="error-message" style="display: none"></div>
    <nav class="nav">
      <div class="nav-logo">
        <h2>WhatsApp Bot</h2>
      </div>
      <ul class="nav-items">
        <li class="nav-item active" data-section="home">é¦–é </li>
        <li class="nav-item" data-section="groups">ç¾¤çµ„</li>
        <li class="nav-item" data-section="contacts">å€‹äºº</li>
        <li class="nav-item" data-section="commands">æŒ‡ä»¤</li>
        <li class="nav-item" data-section="console">Console</li>
      </ul>
    </nav>

    <div class="nav-bottom-actions-floating">
      <button
        id="theme-toggle"
        class="nav-action-btn"
        title="åˆ‡æ›æ·±æ·ºè‰²"
        style="
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 6px 0;
          width: 44px;
          height: 44px;
          min-width: 44px;
          min-height: 44px;
          background: #fff;
          border: 1.5px solid var(--primary-light);
          border-radius: 50%;
          box-shadow: 0 1px 4px rgba(76, 175, 80, 0.1);
        "
      >
        <img
          id="theme-icon"
          src="https://fonts.gstatic.com/s/i/materialicons/dark_mode/v1/24px.svg"
          alt="Theme"
          style="width: 22px; height: 22px"
        />
      </button>
      <button
        id="lang-toggle"
        class="nav-action-btn"
        title="åˆ‡æ›èªè¨€"
        style="
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 6px 0;
          width: 44px;
          height: 44px;
          min-width: 44px;
          min-height: 44px;
          background: #fff;
          border: 1.5px solid var(--primary-light);
          border-radius: 50%;
          box-shadow: 0 1px 4px rgba(76, 175, 80, 0.1);
          margin: 10px 0;
        "
      >
        <img
          id="lang-icon"
          src="https://fonts.gstatic.com/s/i/materialicons/translate/v1/24px.svg"
          alt="Lang"
          style="width: 22px; height: 22px"
        />
      </button>
      <button
        id="update-html-btn"
        class="nav-action-btn update-btn"
        style="
          padding: 6px 0;
          width: 44px;
          height: 44px;
          min-width: 44px;
          min-height: 44px;
          background: var(--primary-dark);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
        "
      >
        <img
          src="https://fonts.gstatic.com/s/i/materialicons/refresh/v1/24px.svg"
          alt="Update"
          style="width: 22px; height: 22px; filter: invert(1)"
        />
      </button>

      <!-- æ–°å¢ç‰ˆæœ¬è™Ÿé¡¯ç¤ºå…ƒç´  -->
      <div
        id="version-number"
        style="
          font-size: 0.8rem;
          text-align: center;
          margin-top: 5px;
          color: var(--text-secondary);
          font-weight: 500;
        "
      >
        v1.0.0
      </div>
    </div>

    <main class="main-content">
      <!-- é¦–é  Sectionï¼Œä¿®æ”¹ QR ç¢¼å®¹å™¨çµæ§‹ -->
      <section id="home" class="section active">
        <h2>Bot æ§åˆ¶å°</h2>
        <div class="status offline" id="bot-status">é›¢ç·š</div>
        <button class="btn btn-primary" id="toggle-bot">å•Ÿå‹• Bot</button>
        <div
          id="qrcode"
          style="
            margin-top: 20px;
            text-align: center;
            min-height: 340px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
          "
        >
          <div id="qr-loading" style="display: none">
            <div
              class="spinner"
              style="
                width: 40px;
                height: 40px;
                margin: 0 auto;
                border: 4px solid rgba(76, 175, 80, 0.2);
                border-radius: 50%;
                border-top-color: #4caf50;
                animation: qr-spin 1s linear infinite;
              "
            ></div>
            <p
              class="loading-text"
              style="margin-top: 10px; color: #4caf50; font-weight: 500"
            >
              æ­£åœ¨ç²å– WhatsApp ç™»å…¥ç¢¼<span class="loading-dots">...</span>
            </p>
          </div>
          <img
            id="qr-image"
            style="display: none; max-width: 300px; width: 100%; height: auto"
            alt="WhatsApp QR Code"
          />
        </div>
      </section>

      <!-- ç¾¤çµ„ Section -->
      <section id="groups" class="section">
        <h2>ç¾¤çµ„ç®¡ç†</h2>
        <div class="form-group">
          <input type="text" id="group-name" placeholder="ç¾¤çµ„åç¨±" />
          <button class="btn btn-primary" onclick="addGroup()">
            æœå°‹ä¸¦æ·»åŠ ç¾¤çµ„
          </button>
        </div>
        <div id="groups-list" class="list-container"></div>
      </section>

      <!-- å€‹äºº Section -->
      <section id="contacts" class="section">
        <h2>å€‹äººè¯çµ¡äººç®¡ç†</h2>
        <div class="form-group">
          <input type="text" id="contact-prefix" placeholder="åœ‹ç¢¼ (ä¾‹: 852)" />
          <input type="text" id="contact-number" placeholder="é›»è©±è™Ÿç¢¼" />
          <input type="text" id="contact-name" placeholder="å‚™è¨»åç¨±" />
          <button class="btn btn-primary" onclick="addContact()">
            æ–°å¢è¯çµ¡äºº
          </button>
        </div>
        <div id="contacts-list" class="list-container"></div>
      </section>

      <!-- æŒ‡ä»¤ Section -->
      <section id="commands" class="section">
        <h2>æŒ‡ä»¤ç®¡ç†</h2>
        <div class="command-editor">
          <div class="form-group">
            <label>è§¸ç™¼æ¢ä»¶</label>
            <div class="trigger-conditions" id="trigger-conditions">
              <input type="text" placeholder="æ–°å¢é—œéµè©" />
              <label class="switch-label">
                <span>å¿½ç•¥å¤§å°å¯«</span>
                <span class="switch">
                  <input type="checkbox" name="toLowerCase" />
                  <span class="slider"></span>
                </span>
              </label>
              <label class="switch-label">
                <span>é–‹é ­åŒ¹é…</span>
                <span class="switch">
                  <input type="checkbox" name="startsWith" />
                  <span class="slider"></span>
                </span>
              </label>
              <label class="switch-label">
                <span>å¼•ç”¨è¨Šæ¯</span>
                <span class="switch">
                  <input type="checkbox" name="quotedMsg" />
                  <span class="slider"></span>
                </span>
              </label>
              <label class="switch-label">
                <span>è‡ªå‹•è§¸ç™¼</span>
                <span class="switch">
                  <input type="checkbox" name="autoTrigger" />
                  <span class="slider"></span>
                </span>
              </label>
              <!-- è‡ªå‹•è§¸ç™¼è¨­å®šé¸æ“‡å™¨ï¼Œé»˜èªéš±è—ï¼Œå‹¾é¸è‡ªå‹•è§¸ç™¼å¾Œé¡¯ç¤º -->
              <div
                id="auto-trigger-selector"
                style="
                  display: none;
                  margin-top: 10px;
                  border-top: 1px solid #e0e0e0;
                  padding-top: 10px;
                "
              >
                <div style="font-size: 0.9em; margin-bottom: 8px; color: #666">
                  è¨­å®šè§¸ç™¼é–“éš”:
                </div>
                <div
                  style="
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    margin-bottom: 8px;
                  "
                >
                  <input
                    type="number"
                    name="autoHours"
                    min="0"
                    style="width: 160px; text-align: center"
                    placeholder="æ™‚"
                    value="0"
                  />
                  <span>æ™‚</span>
                  <input
                    type="number"
                    name="autoMinutes"
                    min="0"
                    max="59"
                    style="width: 160px; text-align: center"
                    placeholder="åˆ†"
                    value="0"
                  />
                  <span>åˆ†</span>
                  <input
                    type="number"
                    name="autoSeconds"
                    min="0"
                    max="59"
                    style="width: 160px; text-align: center"
                    placeholder="ç§’"
                    value="0"
                  />
                  <span>ç§’</span>
                </div>
                <div style="font-size: 0.85em; color: #666; margin-top: 5px">
                  <i
                    class="material-icons"
                    style="font-size: 14px; vertical-align: middle"
                    >info</i
                  >
                  è¨­ç½®ç‚º 0 æ™‚ 0 åˆ† 0 ç§’ å°‡ç„¡æ³•è§¸ç™¼ï¼Œè«‹è‡³å°‘è¨­ç½® 1 ç§’ä»¥ä¸Š
                </div>
              </div>
              <label class="switch-label">
                <span>ä½¿ç”¨æ­£è¡¨é”å¼</span>
                <span class="switch">
                  <input type="checkbox" name="isRegex" />
                  <span class="slider"></span>
                </span>
              </label>
              <label class="switch-label">
                <span>åœ–ç‰‡</span>
                <span class="switch">
                  <input type="checkbox" name="hasMedia" />
                  <span class="slider"></span>
                </span>
              </label>
              <label class="switch-label">
                <span>è¡¨æƒ…åæ‡‰</span>
                <span class="switch">
                  <input type="checkbox" name="hasReaction" />
                  <span class="slider"></span>
                </span>
              </label>

              <!-- è¡¨æƒ…åæ‡‰é¸æ“‡å™¨ï¼Œé»˜èªéš±è—ï¼Œå‹¾é¸è¡¨æƒ…åæ‡‰å¾Œé¡¯ç¤º -->
              <div
                id="reaction-selector"
                style="
                  display: none;
                  margin-top: 10px;
                  border-top: 1px solid #e0e0e0;
                  padding-top: 10px;
                  max-width: 500px;
                "
              >
                <div style="font-size: 0.9em; margin-bottom: 8px; color: #666">
                  é¸æ“‡è¦è§¸ç™¼çš„è¡¨æƒ…ç¬¦è™Ÿï¼š
                </div>
                <!-- è¡¨æƒ…ç¬¦è™Ÿåˆ†é¡æ¨™ç±¤ -->
                <div
                  class="emoji-tabs"
                  style="
                    margin-bottom: 10px;
                    display: flex;
                    gap: 8px;
                    flex-wrap: wrap;
                  "
                >
                  <span
                    class="emoji-tab active"
                    data-category="frequent"
                    style="
                      cursor: pointer;
                      padding: 5px 12px;
                      border-radius: 15px;
                      background: #e8f5e9;
                      color: #388e3c;
                      font-size: 0.9em;
                    "
                    >å¸¸ç”¨</span
                  >
                  <span
                    class="emoji-tab"
                    data-category="smileys"
                    style="
                      cursor: pointer;
                      padding: 5px 12px;
                      border-radius: 15px;
                      background: #f5f5f5;
                      color: #666;
                      font-size: 0.9em;
                    "
                    >ç¬‘è‡‰</span
                  >
                  <span
                    class="emoji-tab"
                    data-category="gestures"
                    style="
                      cursor: pointer;
                      padding: 5px 12px;
                      border-radius: 15px;
                      background: #f5f5f5;
                      color: #666;
                      font-size: 0.9em;
                    "
                    >æ‰‹å‹¢</span
                  >
                  <span
                    class="emoji-tab"
                    data-category="love"
                    style="
                      cursor: pointer;
                      padding: 5px 12px;
                      border-radius: 15px;
                      background: #f5f5f5;
                      color: #666;
                      font-size: 0.9em;
                    "
                    >æ„›å¿ƒ</span
                  >
                  <span
                    class="emoji-tab"
                    data-category="symbols"
                    style="
                      cursor: pointer;
                      padding: 5px 12px;
                      border-radius: 15px;
                      background: #f5f5f5;
                      color: #666;
                      font-size: 0.9em;
                    "
                    >ç¬¦è™Ÿ</span
                  >
                </div>

                <!-- å¸¸ç”¨è¡¨æƒ… -->
                <div
                  class="emoji-category"
                  id="emoji-frequent"
                  style="display: flex; flex-wrap: wrap; gap: 8px"
                >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="â¤ï¸"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >â¤ï¸</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜‚"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜‚</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜¢"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜¢</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜®"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜®</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ™"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ™</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ”¥"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ”¥</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‰"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‰</span
                  >
                </div>

                <!-- ç¬‘è‡‰è¡¨æƒ… -->
                <div
                  class="emoji-category"
                  id="emoji-smileys"
                  style="display: none; flex-wrap: wrap; gap: 8px"
                >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜€"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜€</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜ƒ"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜ƒ</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜„"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜„</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜†"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜†</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜…"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜…</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤£"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤£</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜‚"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜‚</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ™‚"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ™‚</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜Š"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜Š</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜‡"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜‡</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¥°"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¥°</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜˜"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜˜</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜—"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜—</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜‹"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜‹</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜›"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜›</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜œ"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜œ</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤ª"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤ª</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤‘"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤‘</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤—"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤—</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤­"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤­</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤«"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤«</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤”"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤”</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜‘"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜‘</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜¶"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜¶</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜’"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜’</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ™„"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ™„</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ˜¬"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ˜¬</span
                  >
                </div>

                <!-- æ‰‹å‹¢è¡¨æƒ… -->
                <div
                  class="emoji-category"
                  id="emoji-gestures"
                  style="display: none; flex-wrap: wrap; gap: 8px"
                >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘Œ"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘Œ</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="âœŒï¸"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >âœŒï¸</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤Ÿ"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤Ÿ</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤˜"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤˜</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤™"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤™</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘ˆ"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘ˆ</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘‰"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘‰</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘†"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘†</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘‡"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘‡</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="âœ‹"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >âœ‹</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤š"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤š</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ–"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ–</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ––"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ––</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘‹"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘‹</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="âœï¸"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >âœï¸</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‘"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‘</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ™Œ"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ™Œ</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ™"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ™</span
                  >
                </div>

                <!-- æ„›å¿ƒè¡¨æƒ… -->
                <div
                  class="emoji-category"
                  id="emoji-love"
                  style="display: none; flex-wrap: wrap; gap: 8px"
                >
                  <span
                    class="emoji-item"
                    data-emoji="â¤ï¸"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >â¤ï¸</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ§¡"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ§¡</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’›"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’›</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’š"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’š</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’™"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’™</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’œ"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’œ</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ–¤"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ–¤</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ¤"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ¤</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’”"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’”</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’•"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’•</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’“"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’“</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’—"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’—</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’–"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’–</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’˜"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’˜</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’</span
                  >
                </div>

                <!-- ç¬¦è™Ÿè¡¨æƒ… -->
                <div
                  class="emoji-category"
                  id="emoji-symbols"
                  style="display: none; flex-wrap: wrap; gap: 8px"
                >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ”¥"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ”¥</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="âœ¨"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >âœ¨</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ‰"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ‰</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸŠ"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸŠ</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’¯"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’¯</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="â­"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >â­</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸŒŸ"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸŒŸ</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’«"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’«</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’¥"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’¥</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’¢"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’¢</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’¦"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’¦</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ’¨"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ’¨</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="ğŸ•³ï¸"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >ğŸ•³ï¸</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="â“"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >â“</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="â—"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >â—</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="â€¼ï¸"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >â€¼ï¸</span
                  >
                  <span
                    class="emoji-item"
                    data-emoji="â‰ï¸"
                    style="
                      cursor: pointer;
                      font-size: 1.8em;
                      padding: 5px;
                      border-radius: 4px;
                    "
                    >â‰ï¸</span
                  >
                </div>

                <div
                  id="selected-emoji"
                  style="margin-top: 10px; font-size: 0.9em"
                >
                  <span style="color: #666">å·²é¸æ“‡ï¼š</span>
                  <span
                    id="selected-emoji-value"
                    style="font-weight: bold; font-size: 1.3em"
                    >ç„¡</span
                  >
                </div>
              </div>

              <label class="switch-label">
                <span>ç‰¹å®šæ™‚æ®µ</span>
                <span class="switch">
                  <input type="checkbox" name="timeRange" />
                  <span class="slider"></span>
                </span>
              </label>

              <!-- æ™‚é–“ç¯„åœé¸æ“‡å™¨ï¼Œé»˜èªéš±è—ï¼Œå‹¾é¸ç‰¹å®šæ™‚æ®µå¾Œé¡¯ç¤º -->
              <div
                id="time-range-selector"
                style="
                  display: none;
                  margin-top: 10px;
                  border-top: 1px solid #e0e0e0;
                  padding-top: 10px;
                "
              >
                <div
                  style="
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    margin-bottom: 8px;
                  "
                >
                  <label style="min-width: 60px; margin: 0">é–‹å§‹æ™‚é–“:</label>
                  <input
                    type="time"
                    name="startTime"
                    style="flex: 1; max-width: 150px"
                    value="00:00"
                  />
                </div>
                <div style="display: flex; gap: 10px; align-items: center">
                  <label style="min-width: 60px; margin: 0">çµæŸæ™‚é–“:</label>
                  <input
                    type="time"
                    name="endTime"
                    style="flex: 1; max-width: 150px"
                    value="23:59"
                  />
                </div>
              </div>
              <button class="btn btn-primary" onclick="addTrigger()">
                æ–°å¢è§¸ç™¼æ¢ä»¶
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>å›æ‡‰é¡å‹</label>
            <div
              style="display: flex; align-items: center; margin-bottom: 10px"
            >
              <select id="response-type" style="margin: 0; flex: 1">
                <option value="text">æ–‡å­—</option>
                <option value="image">åœ–ç‰‡</option>
                <option value="video">å½±ç‰‡</option>
                <option value="function">Function</option>
              </select>
              <button
                id="template-btn"
                class="btn template-btn"
                style="
                  display: none;
                  margin-left: 10px;
                  background: #3f51b5;
                  color: white;
                "
              >
                <span
                  class="material-icons"
                  style="
                    font-size: 16px;
                    margin-right: 4px;
                    vertical-align: text-bottom;
                  "
                  >code</span
                >ç¯„æœ¬
              </button>
            </div>
            <textarea
              id="response-content"
              placeholder="å›æ‡‰å…§å®¹"
              style="min-height: 120px; height: 120px"
            ></textarea>
            <input
              type="file"
              id="response-file"
              style="display: none"
              accept="image/*,video/*"
            />
            <div
              id="function-help"
              style="
                display: none;
                margin-top: 10px;
                font-size: 0.9em;
                color: #666;
                background: #f9f9f9;
                padding: 10px;
                border-radius: 4px;
                border: 1px solid #eee;
              "
            >
              <strong>ã€Function æŒ‡ä»¤èªªæ˜ã€‘</strong><br />
              1. ç¯„ä¾‹ï¼š
              <pre
                style="
                  background: #eee;
                  border-radius: 4px;
                  padding: 6px;
                  margin: 4px 0;
                "
              >
const axios = require('axios');
const res = await axios.get('https://api.github.com');
return res.data;</pre
              >
              2. <b>msg</b> å’Œ <b>client</b> åƒæ•¸å¯ç”¨ï¼Œä¾‹å¦‚
              <code>msg.reply()</code> æˆ–
              <code>client.sendMessage(...)</code>ã€‚<br />
              3. å¦‚éœ€ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼Œè«‹å…ˆæ–¼ä¸»æ©Ÿ <code>npm install</code>ï¼Œä¸¦ç”¨
              <code>require</code> è¼‰å…¥ã€‚<br />
              4. <b>ä¸èƒ½</b>ä½¿ç”¨ importï¼Œåªèƒ½ requireã€‚<br />
              5. ä½ å¯«çš„å…§å®¹æœƒè‡ªå‹•åŒ…è£æˆ
              <code>module.exports = async function(msg, client) { ... }</code>
              ä¸¦å„²å­˜æ–¼ <code>data/functions/æŒ‡ä»¤ID.js</code>ã€‚<br /><br />

              <strong>ã€AIæç¤ºè©ç¯„ä¾‹ã€‘</strong><br />
              åœ¨è©¢å• AI æ™‚ï¼Œå¯ä»¥é€™æ¨£æè¿°ä½ è¦çš„åŠŸèƒ½:<br />
              <pre
                style="
                  background: #f1f8e9;
                  border-radius: 4px;
                  padding: 8px;
                  margin: 6px 0;
                "
              >
è«‹å¹«æˆ‘å¯«ä¸€å€‹ WhatsApp bot function:
- ä½¿ç”¨ node.js
- æ¥æ”¶ msg å’Œ client åƒæ•¸
- ä½¿ç”¨ async/await
- åªç”¨ require (ä¸è¦ç”¨ import)
- msg.reply() æˆ– client.sendMessage() å›è¦†
- åŠŸèƒ½: [æè¿°ä½ æƒ³è¦çš„åŠŸèƒ½]</pre
              >
            </div>
          </div>

          <div class="form-group">
            <label>è§¸ç™¼åå–®</label>
            <div
              id="trigger-targets-tags"
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                margin-bottom: 8px;
              "
            ></div>
            <button
              type="button"
              class="btn btn-primary"
              id="open-target-modal"
              style="margin-bottom: 18px; background-color: #2196f3"
            >
              é¸æ“‡è§¸ç™¼å°è±¡
            </button>
          </div>
          <!-- Modal å½ˆçª— -->
          <div
            id="target-modal"
            class="modal"
            style="
              display: none;
              position: fixed;
              z-index: 2000;
              left: 0;
              top: 0;
              width: 100vw;
              height: 100vh;
              background: rgba(0, 0, 0, 0.25);
              align-items: center;
              justify-content: center;
            "
          >
            <div
              class="modal-content"
              style="
                padding: 24px 20px;
                border-radius: 10px;
                min-width: 340px;
                max-width: 96vw;
                max-height: 90vh;
                overflow: auto;
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
              "
            >
              <div
                id="modal-header"
                style="display: flex; gap: 12px; margin-bottom: 16px"
              ></div>
              <div
                id="modal-selected-tags"
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 6px;
                  margin-bottom: 10px;
                "
              ></div>
              <div
                id="modal-list"
                style="max-height: 320px; overflow: auto"
              ></div>
              <div style="margin-top: 18px; text-align: right">
                <button class="btn btn-primary" id="modal-confirm">ç¢ºå®š</button>
                <button class="btn btn-danger" id="modal-cancel">å–æ¶ˆ</button>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" onclick="saveCommand()">
            å„²å­˜æŒ‡ä»¤
          </button>
        </div>
        <div id="commands-list" class="list-container"></div>
      </section>

      <!-- Console Section -->
      <section id="console" class="section">
        <h2>ç³»çµ±æ—¥èªŒ</h2>
        <div class="console-controls">
          <button class="btn btn-primary" onclick="clearConsole()">
            æ¸…é™¤æ—¥èªŒ
          </button>
          <button class="btn btn-primary" onclick="exportLogs()">
            å°å‡ºæ—¥èªŒ
          </button>
          <select id="logLevel" onchange="filterLogs()">
            <option value="all">å…¨éƒ¨æ—¥èªŒ</option>
            <option value="log">ä¸€èˆ¬æ—¥èªŒ</option>
            <option value="info">ä¿¡æ¯</option>
            <option value="warn">è­¦å‘Š</option>
            <option value="error">éŒ¯èª¤</option>
          </select>
        </div>
        <div id="console-logs"></div>
        <div id="terminal-section" style="margin-top: 24px">
          <h3 style="margin-bottom: 8px">
            ç®¡ç†å“¡ Terminalï¼ˆåƒ…é™ npm install æŒ‡ä»¤ï¼‰
          </h3>
          <form
            id="terminal-form"
            style="display: flex; gap: 8px; align-items: center"
          >
            <input
              id="terminal-input"
              type="text"
              placeholder="ä¾‹å¦‚ï¼šnpm i axios"
              style="
                flex: 1;
                padding: 8px;
                border-radius: 4px;
                border: 1px solid #ccc;
              "
              autocomplete="off"
            />
            <button type="submit" class="btn btn-primary">åŸ·è¡Œ</button>
          </form>
          <pre
            id="terminal-output"
            style="
              background: #222;
              color: #b9f6ca;
              padding: 12px;
              border-radius: 6px;
              margin-top: 8px;
              min-height: 60px;
              max-height: 200px;
              overflow: auto;
              font-size: 0.95em;
            "
          ></pre>
        </div>
      </section>
    </main>

    <!-- AI ç¯„æœ¬æ¨¡æ…‹çª—å£ -->
    <div
      id="template-modal"
      class="modal"
      style="
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.25);
        align-items: center;
        justify-content: center;
      "
    >
      <div
        class="modal-content"
        style="
          background: #fff;
          padding: 24px 20px;
          border-radius: 12px;
          min-width: 460px;
          max-width: 96vw;
          max-height: 90vh;
          overflow: auto;
          box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
        "
      >
        <h3
          style="
            margin-bottom: 16px;
            color: #3f51b5;
            display: flex;
            align-items: center;
            gap: 8px;
          "
        >
          <span class="material-icons">code</span>
          <span>AI åŠŸèƒ½ç¯„æœ¬</span>
          <div
            class="close-btn"
            style="
              margin-left: auto;
              cursor: pointer;
              font-size: 20px;
              color: #666;
            "
          >
            &times;
          </div>
        </h3>
        <form>
          <div id="template-content">
            <div class="template-form">
              <div class="form-group">
                <label for="openrouter_api_key"
                  >OPENROUTER_API_KEY <span class="required">*</span></label
                >
                <input
                  type="password"
                  id="openrouter_api_key"
                  placeholder="è¼¸å…¥æ‚¨çš„ OpenRouter API å¯†é‘°"
                  autocomplete="false"
                  required
                />
              </div>
              <div class="form-group">
                <label for="model">MODEL <span class="required">*</span></label>
                <input
                  type="text"
                  id="model"
                  placeholder="ä¾‹å¦‚: openai/gpt-3.5-turbo"
                  required
                />
              </div>
              <div class="form-group">
                <label for="api_url"
                  >API_URL <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="api_url"
                  placeholder="ä¾‹å¦‚: https://openrouter.ai/api/v1/chat/completions"
                  required
                />
              </div>
              <div class="form-group">
                <label for="default_system_prompt"
                  >defaultSystemPrompt
                  <span class="optional">(å¯é¸)</span></label
                >
                <textarea
                  id="default_system_prompt"
                  placeholder="ç³»çµ±æç¤ºè© (å¯ç•™ç©º)"
                  rows="3"
                ></textarea>
              </div>
              <div class="form-group">
                <label for="user_system_prompts_format"
                  >userSystemPrompts <span class="optional">(å¯é¸)</span></label
                >
                <textarea
                  id="user_system_prompts_format"
                  placeholder="æä¾›ä½¿ç”¨è€…æç¤ºè©æ ¼å¼èªªæ˜ (å¯ç•™ç©º)"
                  rows="3"
                ></textarea>
              </div>
            </div>
          </div>
        </form>

        <div style="margin-top: 20px; text-align: right"></div>
        <button
          class="btn"
          id="modal-template-cancel"
          style="background: #f5f5f5; color: #333; margin-right: 8px"
        >
          å–æ¶ˆ
        </button>
        <button
          class="btn btn-primary"
          id="modal-template-confirm"
          style="background: #3f51b5"
        >
          ç¢ºå®š
        </button>
      </div>
    </div>

    <script>
      // å…¨å±€è®Šé‡
      let currentGroups = [];
      let currentContacts = [];
      let currentCommands = [];
      let currentTriggers = [];
      let editingCommandId = null; // æ–°å¢ï¼šè¿½è¹¤ç›®å‰æ˜¯å¦åœ¨ç·¨è¼¯æŒ‡ä»¤
      let editingContactId = null;
      const socket = io();
      let isConnected = false;
      let codeMirrorEditor = null;
      let selectedTargets = [];

      // æ·»åŠ æ™‚é–“ç¯„åœé¸æ“‡å™¨çš„é¡¯ç¤º/éš±è—åŠŸèƒ½
      document.addEventListener("DOMContentLoaded", () => {
        const timeRangeCheckbox = document.querySelector(
          'input[name="timeRange"]'
        );
        const timeRangeSelector = document.getElementById(
          "time-range-selector"
        );

        if (timeRangeCheckbox && timeRangeSelector) {
          timeRangeCheckbox.addEventListener("change", function () {
            timeRangeSelector.style.display = this.checked ? "block" : "none";
          });
        }

        const reactionCheckbox = document.querySelector(
          'input[name="hasReaction"]'
        );
        const reactionSelector = document.getElementById("reaction-selector");

        if (reactionCheckbox && reactionSelector) {
          reactionCheckbox.addEventListener("change", function () {
            reactionSelector.style.display = this.checked ? "block" : "none";
          });
        }

        // è¡¨æƒ…ç¬¦è™Ÿé¸æ“‡åŠŸèƒ½
        const emojiItems = document.querySelectorAll(".emoji-item");
        const selectedEmojiValue = document.getElementById(
          "selected-emoji-value"
        );

        if (emojiItems && selectedEmojiValue) {
          emojiItems.forEach((item) => {
            item.addEventListener("click", function () {
              // ç§»é™¤ä¹‹å‰é¸ä¸­çš„è¡¨æƒ…é«˜äº®
              document
                .querySelectorAll(".emoji-item.selected")
                .forEach((el) => {
                  el.classList.remove("selected");
                  el.style.background = "";
                });

              // é«˜äº®ç•¶å‰é¸ä¸­çš„è¡¨æƒ…
              this.classList.add("selected");
              this.style.background = "#e8f5e9";

              // æ›´æ–°å·²é¸æ“‡çš„è¡¨æƒ…é¡¯ç¤º
              selectedEmojiValue.textContent = this.dataset.emoji;
            });
          });
        }

        // è¡¨æƒ…åˆ†é¡åˆ‡æ›åŠŸèƒ½
        const emojiTabs = document.querySelectorAll(".emoji-tab");
        if (emojiTabs) {
          emojiTabs.forEach((tab) => {
            tab.addEventListener("click", function () {
              // åˆ‡æ›åˆ†é¡æ¨™ç±¤æ¨£å¼
              document.querySelectorAll(".emoji-tab").forEach((t) => {
                t.classList.remove("active");
                t.style.background = "#f5f5f5";
                t.style.color = "#666";
              });
              this.classList.add("active");
              this.style.background = "#e8f5e9";
              this.style.color = "#388e3c";

              // åˆ‡æ›å°æ‡‰çš„è¡¨æƒ…åˆ†é¡é¡¯ç¤º
              const category = this.dataset.category;
              document.querySelectorAll(".emoji-category").forEach((c) => {
                c.style.display = "none";
              });
              document.getElementById(`emoji-${category}`).style.display =
                "flex";
            });
          });
        }
      });

      function cleanupCommandsSection() {
        if (codeMirrorEditor) {
          codeMirrorEditor.toTextArea();
          codeMirrorEditor = null;
        }
        currentTriggers = [];
        selectedTargets = [];
        editingCommandId = null;

        // é‡ç½®æ‰€æœ‰è¼¸å…¥
        document.getElementById("response-type").value = "text";
        document.getElementById("response-content").value = "";
        document.getElementById("response-file").value = "";

        // é‡ç½®è§¸ç™¼æ¢ä»¶
        const checkboxes = document.querySelectorAll(
          '#trigger-conditions input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => (cb.checked = false));

        // éš±è—ç›¸é—œé¸æ“‡å™¨
        document.getElementById("time-range-selector").style.display = "none";
        document.getElementById("reaction-selector").style.display = "none";
      }

      function setupCodeMirror() {
        if (codeMirrorEditor) return;
        const textarea = document.getElementById("response-content");
        codeMirrorEditor = CodeMirror.fromTextArea(textarea, {
          mode: "javascript",
          theme: "material",
          lineNumbers: true,
          lineWrapping: true,
          indentUnit: 2,
          tabSize: 2,
          autofocus: true,
          viewportMargin: Infinity,
          matchBrackets: true,
          autoCloseBrackets: true,
          styleActiveLine: true,
          lint: {
            esversion: 11,
            asi: true,
            browser: true,
          },
          gutters: [
            "CodeMirror-lint-markers",
            "CodeMirror-linenumbers",
            "CodeMirror-foldgutter",
            "CodeMirror-emoji-markers", // æ–°å¢è¡¨æƒ…ç¬¦è™Ÿæ¨™è¨˜
          ],
          foldGutter: true,
        });
        codeMirrorEditor.setSize("100%", "240px");
        codeMirrorEditor.setOption("extraKeys", {
          "Ctrl-F": "findPersistent", // ä¿ç•™çµ¦ä½¿ç”¨å¤–æ¥éµç›¤çš„ç”¨æˆ¶
          "Cmd-F": "findPersistent", // Macæ¨™æº–æœå°‹å¿«æ·éµ
          "Cmd-G": "findNext", // Macæ¨™æº–å°‹æ‰¾ä¸‹ä¸€å€‹
          "Shift-Cmd-G": "findPrev", // Macæ¨™æº–å°‹æ‰¾ä¸Šä¸€å€‹
          "Cmd-/": "toggleComment", // Macæ¨™æº–åˆ‡æ›è¨»è§£
          "Cmd-Z": "undo", // Macæ¨™æº–æ’¤éŠ·
          "Shift-Cmd-Z": "redo", // Macæ¨™æº–é‡åš
          "Cmd-[": "indentLess", // æ¸›å°‘ç¸®æ’
          "Cmd-]": "indentMore", // å¢åŠ ç¸®æ’
          "Cmd-A": "selectAll", // å…¨é¸
          "Cmd-D": "deleteLine", // åˆªé™¤æ•´è¡Œ
          "Option-Up": "swapLineUp", // ä¸Šç§»ä¸€è¡Œ
          "Option-Down": "swapLineDown", // ä¸‹ç§»ä¸€è¡Œ
          F11: function (cm) {
            // å…¨è¢å¹•åˆ‡æ›
            cm.setOption("fullScreen", !cm.getOption("fullScreen"));
          },
          Esc: function (cm) {
            // é€€å‡ºå…¨è¢å¹•
            if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
          },
        });

        const toolbar = document.createElement("div");
        toolbar.className = "cm-toolbar";
        toolbar.innerHTML = `
  <button title="æœå°‹ (Cmd+F)" class="cm-btn cm-search">
    <span class="material-icons" style="font-size: 18px;">search</span>
  </button>
  <button title="æ ¼å¼åŒ–ç¨‹å¼ç¢¼" class="cm-btn cm-format">
    <span class="material-icons" style="font-size: 18px;">format_align_left</span>
  </button>
`;

        // æ’å…¥åˆ° CodeMirror å…ƒç´ å‰é¢
        const cmElement = codeMirrorEditor.getWrapperElement();
        cmElement.parentNode.insertBefore(toolbar, cmElement);

        // æ·»åŠ æœç´¢æŒ‰éˆ•é»æ“Šäº‹ä»¶
        toolbar
          .querySelector(".cm-search")
          .addEventListener("click", function () {
            CodeMirror.commands.findPersistent(codeMirrorEditor);
          });
        // åœ¨ setupCodeMirror å‡½æ•¸ä¸­æ·»åŠ æ ¼å¼åŒ–æŒ‰éˆ•äº‹ä»¶
        toolbar
          .querySelector(".cm-format")
          .addEventListener("click", function () {
            formatCode();
          });

        // æ·»åŠ æ ¼å¼åŒ–åŠŸèƒ½
        function formatCode() {
          try {
            const code = codeMirrorEditor.getValue();
            const formattedCode = prettier.format(code, {
              parser: "babel",
              plugins: prettierPlugins,
              semi: true,
              singleQuote: false,
              tabWidth: 2,
              printWidth: 80,
            });

            // ç²å–ç•¶å‰æ¸¸æ¨™ä½ç½®
            const cursor = codeMirrorEditor.getCursor();

            // è¨­ç½®æ ¼å¼åŒ–å¾Œçš„ä»£ç¢¼
            codeMirrorEditor.setValue(formattedCode);

            // å˜—è©¦æ¢å¾©æ¸¸æ¨™ä½ç½®
            try {
              codeMirrorEditor.setCursor(cursor);
            } catch (e) {
              // å¦‚æœå‡ºéŒ¯ï¼Œå‰‡å°‡æ¸¸æ¨™æ”¾åœ¨é–‹é ­
              codeMirrorEditor.setCursor({ line: 0, ch: 0 });
            }

            // é¡¯ç¤ºæˆåŠŸæç¤º
            showNotification("ç¨‹å¼ç¢¼å·²æ ¼å¼åŒ–", "success");
          } catch (err) {
            console.error("æ ¼å¼åŒ–ä»£ç¢¼å¤±æ•—:", err);
            showNotification("æ ¼å¼åŒ–å¤±æ•—: " + err.message, "error");
          }
        }
        function showNotification(message, type = "info") {
          const notification = document.createElement("div");
          notification.className = `cm-notification ${type}`;
          notification.textContent = message;
          document.body.appendChild(notification);

          setTimeout(() => {
            notification.classList.add("show");
            setTimeout(() => {
              notification.classList.remove("show");
              setTimeout(() => {
                document.body.removeChild(notification);
              }, 300);
            }, 2000);
          }, 10);
        }
      }

      function destroyCodeMirror() {
        if (codeMirrorEditor) {
          codeMirrorEditor.toTextArea();
          codeMirrorEditor = null;

          // ç§»é™¤ç›¸é—œçš„ toolbar
          const existingToolbar = document.querySelector(".cm-toolbar");
          if (existingToolbar) {
            existingToolbar.remove();
          }
        }
      }

      // Navigation
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", () => {
          // Remove active class from all items
          document
            .querySelectorAll(".nav-item")
            .forEach((i) => i.classList.remove("active"));
          document
            .querySelectorAll(".section")
            .forEach((s) => s.classList.remove("active"));

          // Add active class to clicked item
          item.classList.add("active");
          document.getElementById(item.dataset.section).classList.add("active");

          // æ¸…ç©ºæŒ‡ä»¤ç·¨è¼¯å€å…§å®¹ï¼ˆåªåœ¨åˆ‡æ›åˆ° commandsï¼‰
          if (item.dataset.section === "commands") {
            // æ¸…ç©ºè§¸ç™¼æ¢ä»¶
            currentTriggers = [];
            renderTriggers();
            // å›æ‡‰é¡å‹é è¨­ç‚º text
            document.getElementById("response-type").value = "text";
            // è§¸ç™¼å›æ‡‰é¡å‹åˆ‡æ›äº‹ä»¶ï¼Œç¢ºä¿ UI ç‹€æ…‹æ­£ç¢º
            document
              .getElementById("response-type")
              .dispatchEvent(new Event("change"));
            // æ¸…ç©ºå›æ‡‰å…§å®¹
            if (codeMirrorEditor) codeMirrorEditor.setValue("");
            document.getElementById("response-content").value = "";
            document.getElementById("response-file").value = "";
            // æ¸…ç©ºè§¸ç™¼åå–®
            selectedTargets = [];
            renderTargetTags();
            // é‡ç½®ç·¨è¼¯ç‹€æ…‹èˆ‡æŒ‰éˆ•
            editingCommandId = null;
            const saveBtn = document.querySelector(
              "#commands .btn.btn-primary"
            );
            if (saveBtn) saveBtn.textContent = "å„²å­˜æŒ‡ä»¤";
          }

          // æ¸…ç©ºè¯çµ¡äººè¡¨å–®å…§å®¹ï¼ˆåªåœ¨åˆ‡æ›åˆ° contactsï¼‰
          if (item.dataset.section === "contacts") {
            document.getElementById("contact-prefix").value = "";
            document.getElementById("contact-number").value = "";
            document.getElementById("contact-name").value = "";
            editingContactId = null;
            const saveBtn = document.querySelector(
              "#contacts .btn.btn-primary"
            );
            if (saveBtn) saveBtn.textContent = "æ–°å¢è¯çµ¡äºº";
          }
        });
      });

      async function initializeData() {
        try {
          const fetchData = async (url) => {
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
              throw new TypeError("è¿”å›çš„æ•¸æ“šä¸æ˜¯ JSON æ ¼å¼");
            }
            return response.json();
          };

          const [groups, contacts, commands] = await Promise.all([
            fetchData("/api/groups").catch((error) => {
              console.warn("Failed to load groups:", error);
              return [];
            }),
            fetchData("/api/contacts").catch((error) => {
              console.warn("Failed to load contacts:", error);
              return [];
            }),
            fetchData("/api/commands").catch((error) => {
              console.warn("Failed to load commands:", error);
              return [];
            }),
          ]);

          currentGroups = groups;
          currentContacts = contacts;
          currentCommands = commands;

          renderGroups();
          renderContacts();
          renderCommands();
        } catch (error) {
          console.error("Error loading data:", error);
          showError("æ•¸æ“šåŠ è¼‰å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦");
        }
      }

      // Bot Status
      socket.on("qr", function (qrData) {
        console.log("æ”¶åˆ° QR ç¢¼æ•¸æ“š");
        const qrContainer = document.getElementById("qrcode");
        const qrImage =
          document.querySelector("#qrcode #qr-image") ||
          document.createElement("img");
        const qrLoading = document.querySelector("#qrcode #qr-loading");

        if (!qrData) {
          console.error("æ”¶åˆ°ç©ºçš„ QR ç¢¼æ•¸æ“š");
          return;
        }

        // å¦‚æœ qrImage ä¸åœ¨ DOM ä¸­ï¼Œå‰‡æ·»åŠ å®ƒ
        if (!qrImage.parentElement) {
          qrImage.id = "qr-image";
          qrImage.style.display = "none";
          qrImage.style.maxWidth = "300px";
          qrImage.style.width = "100%";
          qrImage.alt = "WhatsApp QR Code";
          qrContainer.appendChild(qrImage);
        }

        // ä¿æŒè¼‰å…¥ç‹€æ…‹ç›´åˆ°åœ–ç‰‡å®Œå…¨è¼‰å…¥
        if (qrLoading) {
          qrLoading.style.display = "block";
        }
        qrImage.style.display = "none";

        qrImage.onload = function () {
          setTimeout(() => {
            if (qrLoading) {
              qrLoading.style.display = "none";
            }
            qrImage.style.display = "block";
            console.log("QR ç¢¼åœ–ç‰‡è¼‰å…¥å®Œæˆ");
          }, 500); // æ·»åŠ çŸ­æš«å»¶é²ç¢ºä¿åœ–ç‰‡å®Œæ•´é¡¯ç¤º
        };

        qrImage.onerror = function (error) {
          console.error("QR ç¢¼åœ–ç‰‡è¼‰å…¥å¤±æ•—:", error);
          if (qrLoading) {
            qrLoading.style.display = "none";
          }
        };

        qrImage.src = qrData;
      });

      socket.on("ready", () => {
        document.getElementById("qrcode").innerHTML = "";
        document.getElementById("bot-status").textContent = "å·²é€£æ¥";
        document.getElementById("bot-status").className = "status online";
        isConnected = true;
        updateToggleButton();
      });

      socket.on("qr-loading", (loading) => {
        const qrLoading = document.getElementById("qr-loading");
        const qrImage = document.getElementById("qr-image");

        if (qrLoading) {
          qrLoading.style.display = loading ? "block" : "none";
          if (qrImage && !loading) {
            qrImage.style.display = "block";
          }
        }
      });

      socket.on("connect", () => {
        console.log("Connected to server");
      });

      socket.on("connect_error", (error) => {
        console.error("é€£æ¥éŒ¯èª¤:", error);
      });

      socket.on("disconnected", () => {
        document.getElementById("bot-status").textContent = "é›¢ç·š";
        document.getElementById("bot-status").className = "status offline";
        isConnected = false;
        updateToggleButton();
      });

      // æ·»åŠ å¯¦æ™‚æ›´æ–°è™•ç†
      socket.on("groupUpdate", (groups) => {
        currentGroups = groups;
        renderGroups();
      });

      socket.on("commandUpdate", (commands) => {
        currentCommands = commands;
        renderCommands();
      });

      socket.on("updateData", (data) => {
        currentGroups = data.groups;
        currentContacts = data.contacts;
        currentCommands = data.commands;
        renderGroups();
        renderContacts();
        renderCommands();
      });

      // Console åŠŸèƒ½
      function clearConsole() {
        fetch("/api/logs/clear", { method: "POST" })
          .then(() => {
            document.getElementById("console-logs").innerHTML = "";
          })
          .catch((error) => console.error("æ¸…é™¤æ—¥èªŒå¤±æ•—:", error));
      }

      function exportLogs() {
        fetch("/api/logs")
          .then((response) => response.json())
          .then((logs) => {
            const blob = new Blob([JSON.stringify(logs, null, 2)], {
              type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `whatsapp-bot-logs-${new Date().toISOString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          })
          .catch((error) => console.error("å°å‡ºæ—¥èªŒå¤±æ•—:", error));
      }

      function filterLogs() {
        const level = document.getElementById("logLevel").value;
        fetch(`/api/logs?level=${level}`)
          .then((response) => response.json())
          .then((logs) => {
            const container = document.getElementById("console-logs");
            container.innerHTML = logs
              .map(
                (log) => `
              <div class="log-entry log-${log.level}">
                <span class="log-time">[${new Date(
                  log.timestamp
                ).toLocaleString()}]</span>
                <span class="log-level">[${log.level.toUpperCase()}]</span>
                <span class="log-msg">${log.message}</span>
              </div>
            `
              )
              .join("");
            container.scrollTop = container.scrollHeight;
          })
          .catch((error) => console.error("éæ¿¾æ—¥èªŒå¤±æ•—:", error));
      }

      // Socket.IO äº‹ä»¶è™•ç†
      socket.on("console-log", (log) => {
        const container = document.getElementById("console-logs");
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry log-${log.level}`;
        logEntry.innerHTML = `
          <span class="log-time">[${new Date(
            log.timestamp
          ).toLocaleString()}]</span>
          <span class="log-level">[${log.level.toUpperCase()}]</span>
          <span class="log-msg">${log.message}</span>
        `;
        container.appendChild(logEntry);
        container.scrollTop = container.scrollHeight;
      });

      socket.on("logs-cleared", () => {
        document.getElementById("console-logs").innerHTML = "";
      });

      // Toggle Bot
      document.getElementById("toggle-bot").addEventListener("click", () => {
        if (isConnected) {
          console.log("ç™¼é€æ–·é–‹é€£æ¥è«‹æ±‚");
          socket.emit("disconnect-bot");
        } else {
          console.log("æº–å‚™é€£æ¥...");

          const qrContainer = document.getElementById("qrcode");
          if (!qrContainer) {
            console.error("æ‰¾ä¸åˆ° QR ç¢¼å®¹å™¨");
            return;
          }

          qrContainer.innerHTML = `
      <div id="qr-loading" style="display: block;">
        <div class="spinner"></div>
        <p>æ­£åœ¨ç²å– WhatsApp ç™»å…¥ç¢¼...</p>
      </div>
      <img id="qr-image" style="display: none; max-width: 300px; width: 100%;" alt="WhatsApp QR Code" />
    `;

          console.log("ç™¼é€é€£æ¥è«‹æ±‚");
          socket.emit("connect-bot");
        }
      });

      // Show/hide file input based on response type
      document
        .getElementById("response-type")
        .addEventListener("change", (e) => {
          const fileInput = document.getElementById("response-file");
          const textarea = document.getElementById("response-content");
          const functionHelp = document.getElementById("function-help");
          const templateBtn = document.getElementById("template-btn");

          if (e.target.value === "image" || e.target.value === "video") {
            fileInput.style.display = "block";
            if (codeMirrorEditor) destroyCodeMirror();
            textarea.style.display = "none";
            functionHelp.style.display = "none";
            templateBtn.style.display = "none";
          } else if (e.target.value === "function") {
            fileInput.style.display = "none";
            textarea.style.display = "block";
            functionHelp.style.display = "block";
            templateBtn.style.display = "block"; // é¡¯ç¤ºç¯„æœ¬æŒ‰éˆ•
            setTimeout(setupCodeMirror, 0);
          } else {
            fileInput.style.display = "none";
            if (codeMirrorEditor) destroyCodeMirror();
            textarea.style.display = "block";
            functionHelp.style.display = "none";
            templateBtn.style.display = "none";
          }
        });

      function updateToggleButton() {
        const btn = document.getElementById("toggle-bot");
        btn.textContent = isConnected ? "é—œé–‰ Bot" : "å•Ÿå‹• Bot";
      }

      // Groups Management
      async function addGroup() {
        const nameInput = document.getElementById("group-name");
        const groupName = nameInput.value.trim();

        if (!groupName) {
          alert("è«‹è¼¸å…¥ç¾¤çµ„åç¨±");
          return;
        }

        try {
          const response = await fetch("/api/groups/search", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name: groupName }),
          });

          if (response.ok) {
            nameInput.value = "";
            await initializeData(); // é‡æ–°åŠ è¼‰æ•¸æ“š
          } else {
            const error = await response.json();
            alert(error.message || "æ‰¾ä¸åˆ°ç¾¤çµ„");
          }
        } catch (error) {
          console.error("Error adding group:", error);
          alert("æ·»åŠ ç¾¤çµ„å¤±æ•—");
        }
      }

      function renderGroups() {
        const container = document.getElementById("groups-list");
        container.innerHTML = currentGroups
          .map(
            (group) => `
        <div class="list-item">
            <div>
                <strong>${group.name}</strong>
                <div class="text-gray-500">${group.id}</div>
            </div>
            <button class="btn btn-danger" onclick="deleteGroup('${group.id}')">åˆªé™¤</button>
        </div>
    `
          )
          .join("");
      }

      async function deleteGroup(groupId) {
        try {
          const response = await fetch(`/api/groups/${groupId}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          await initializeData();
        } catch (error) {
          console.error("Error deleting group:", error);
          showError("åˆªé™¤ç¾¤çµ„å¤±æ•—");
        }
      }

      function showError(message) {
        // å‡è¨­ä½ æœ‰ä¸€å€‹ç”¨æ–¼é¡¯ç¤ºéŒ¯èª¤çš„ div
        const errorDiv = document.getElementById("error-message");
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
          setTimeout(() => {
            errorDiv.style.display = "none";
          }, 5000);
        } else {
          alert(message);
        }
      }

      // Contacts Management
      async function addContact() {
        const prefixInput = document.getElementById("contact-prefix");
        const numberInput = document.getElementById("contact-number");
        const nameInput = document.getElementById("contact-name");

        const prefix = prefixInput.value.trim();
        const number = numberInput.value.trim();
        const name = nameInput.value.trim();

        if (!prefix || !number || !name) {
          alert("è«‹å¡«å¯«å®Œæ•´çš„è¯çµ¡äººä¿¡æ¯");
          return;
        }

        try {
          let url = "/api/contacts";
          let method = "POST";
          let body = { prefix, number, name };
          if (editingContactId) {
            url = `/api/contacts/${editingContactId}`;
            method = "PUT";
            body = { prefix, number, name };
          }
          const response = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });

          if (response.ok) {
            prefixInput.value = "";
            numberInput.value = "";
            nameInput.value = "";
            editingContactId = null;
            const saveBtn = document.querySelector(
              "#contacts .btn.btn-primary"
            );
            if (saveBtn) saveBtn.textContent = "æ–°å¢è¯çµ¡äºº";
            await initializeData();
          }
        } catch (error) {
          console.error("Error adding contact:", error);
          alert(editingContactId ? "æ›´æ–°è¯çµ¡äººå¤±æ•—" : "æ·»åŠ è¯çµ¡äººå¤±æ•—");
        }
      }

      function renderContacts() {
        const container = document.getElementById("contacts-list");
        container.innerHTML = currentContacts
          .map(
            (contact) => `
        <div class="list-item">
            <div>
                <strong>${contact.name}</strong>
                <div class="text-gray-500">${contact.number}</div>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-primary" onclick="editContact('${contact.id}')">ç·¨è¼¯</button>
              <button class="btn btn-danger" onclick="deleteContact('${contact.id}')">åˆªé™¤</button>
            </div>
        </div>
    `
          )
          .join("");
      }

      function editContact(id) {
        const contact = currentContacts.find((c) => c.id === id);
        if (!contact) return;
        document.getElementById("contact-prefix").value = contact.number.slice(
          0,
          contact.number.length - (contact.number.length > 8 ? 8 : 0)
        );
        document.getElementById("contact-number").value =
          contact.number.slice(-8);
        document.getElementById("contact-name").value = contact.name;
        editingContactId = id;
        const saveBtn = document.querySelector("#contacts .btn.btn-primary");
        if (saveBtn) saveBtn.textContent = "æ›´æ–°è¯çµ¡äºº";
      }

      async function deleteContact(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¯çµ¡äººå—ï¼Ÿ")) return;

        try {
          const response = await fetch(`/api/contacts/${id}`, {
            method: "DELETE",
          });

          if (response.ok) {
            await initializeData();
          }
        } catch (error) {
          console.error("Error deleting contact:", error);
          alert("åˆªé™¤è¯çµ¡äººå¤±æ•—");
        }
      }

      // Commands Management
      function addTrigger() {
        const triggerInput = document.querySelector(
          '#trigger-conditions input[type="text"]'
        );
        const isRegex = document.querySelector(
          '#trigger-conditions input[name="isRegex"]'
        );
        const toLowerCase = document.querySelector(
          '#trigger-conditions input[name="toLowerCase"]'
        );
        const startsWith = document.querySelector(
          '#trigger-conditions input[name="startsWith"]'
        );
        const quotedMsg = document.querySelector(
          '#trigger-conditions input[name="quotedMsg"]'
        );
        const hasMedia = document.querySelector(
          '#trigger-conditions input[name="hasMedia"]'
        );
        const hasReaction = document.querySelector(
          '#trigger-conditions input[name="hasReaction"]'
        );
        const timeRange = document.querySelector(
          '#trigger-conditions input[name="timeRange"]'
        );
        const startTime = document.querySelector(
          '#trigger-conditions input[name="startTime"]'
        );
        const endTime = document.querySelector(
          '#trigger-conditions input[name="endTime"]'
        );
        const selectedEmojiValue = document.getElementById(
          "selected-emoji-value"
        );
        const autoTrigger = document.querySelector('input[name="autoTrigger"]');
        const autoHours = document.querySelector('input[name="autoHours"]');
        const autoMinutes = document.querySelector('input[name="autoMinutes"]');
        const autoSeconds = document.querySelector('input[name="autoSeconds"]');

        const keyword = triggerInput.value.trim();

        if (isRegex.checked && keyword) {
          try {
            new RegExp(keyword); // é©—è­‰æ­£è¦è¡¨é”å¼æ˜¯å¦æœ‰æ•ˆ
          } catch (err) {
            alert("ç„¡æ•ˆçš„æ­£è¦è¡¨é”å¼");
            return;
          }
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è§¸ç™¼æ¢ä»¶
        if (
          !keyword &&
          !quotedMsg.checked &&
          !hasMedia.checked &&
          !hasReaction.checked &&
          !timeRange.checked &&
          !autoTrigger.checked
        ) {
          alert("è«‹è¼¸å…¥è§¸ç™¼é—œéµè©æˆ–å‹¾é¸å…¶ä»–è§¸ç™¼æ¢ä»¶");
          return;
        }

        // æª¢æŸ¥è‡ªå‹•è§¸ç™¼æ™‚é–“æ˜¯å¦æœ‰æ•ˆ
        if (autoTrigger.checked) {
          const hours = parseInt(autoHours.value) || 0;
          const minutes = parseInt(autoMinutes.value) || 0;
          const seconds = parseInt(autoSeconds.value) || 0;
          const totalSeconds = hours * 3600 + minutes * 60 + seconds;

          if (totalSeconds <= 0) {
            alert("è‡ªå‹•è§¸ç™¼æ™‚é–“å¿…é ˆå¤§æ–¼ 0 ç§’");
            return;
          }
        }

        // æª¢æŸ¥è¡¨æƒ…åæ‡‰æ˜¯å¦é¸æ“‡è¡¨æƒ…ç¬¦è™Ÿ
        if (
          hasReaction.checked &&
          (!selectedEmojiValue || selectedEmojiValue.textContent === "ç„¡")
        ) {
          alert("è¡¨æƒ…åæ‡‰è§¸ç™¼æ¢ä»¶å¿…é ˆé¸æ“‡ä¸€å€‹è¡¨æƒ…ç¬¦è™Ÿ");
          return;
        }

        const newTrigger = {
          keyword,
          isRegex: isRegex.checked,
          toLowerCase: toLowerCase.checked,
          startsWith: startsWith.checked,
          quotedMsg: quotedMsg.checked,
          hasMedia: hasMedia.checked,
          hasReaction: hasReaction.checked,
          timeRange: timeRange.checked,
          startTime: timeRange.checked ? startTime.value : null,
          endTime: timeRange.checked ? endTime.value : null,
          autoTrigger: autoTrigger.checked,
          autoInterval: autoTrigger.checked
            ? {
                hours: parseInt(autoHours.value) || 0,
                minutes: parseInt(autoMinutes.value) || 0,
                seconds: parseInt(autoSeconds.value) || 0,
              }
            : null,
        };

        // å¦‚æœæœ‰è¡¨æƒ…åæ‡‰å‰‡æ·»åŠ è¡¨æƒ…ç¬¦è™Ÿ
        if (hasReaction.checked) {
          newTrigger.reaction = selectedEmojiValue.textContent;
        }

        currentTriggers.push(newTrigger);

        // é‡ç½®è‡ªå‹•è§¸ç™¼è¡¨å–®
        isRegex.checked = false;
        triggerInput.value = "";
        toLowerCase.checked = false;
        startsWith.checked = false;
        quotedMsg.checked = false;
        hasMedia.checked = false;
        hasReaction.checked = false;
        timeRange.checked = false;
        startTime.value = "00:00";
        endTime.value = "23:59";
        selectedEmojiValue.textContent = "ç„¡";
        document.getElementById("time-range-selector").style.display = "none";
        document.getElementById("reaction-selector").style.display = "none";
        autoTrigger.checked = false;
        autoHours.value = "0";
        autoMinutes.value = "0";
        autoSeconds.value = "0";
        document.getElementById("auto-trigger-selector").style.display = "none";

        renderTriggers();
      }

      function renderTriggers() {
        const container = document.getElementById("current-triggers");
        if (!container) return;

        container.innerHTML = currentTriggers
          .map(
            (trigger, index) => `
<div class="trigger-item">
    <span>${trigger.keyword || ""}${
              trigger.isRegex
                ? ' <span style="color:#388e3c;">[Regex]</span>'
                : ""
            }</span>
    ${trigger.toLowerCase ? `<span>å¿½ç•¥å¤§å°å¯«</span>` : ""}
    ${trigger.startsWith ? `<span>é–‹é ­åŒ¹é…</span>` : ""}
    ${trigger.quotedMsg ? `<span>å¼•ç”¨è¨Šæ¯</span>` : ""}
    ${trigger.hasMedia ? `<span>åœ–ç‰‡</span>` : ""}
    ${trigger.hasReaction ? `<span>è¡¨æƒ…åæ‡‰ (${trigger.reaction})</span>` : ""}
    ${
      trigger.timeRange
        ? `<span>ç‰¹å®šæ™‚æ®µ (${trigger.startTime} - ${trigger.endTime})</span>`
        : ""
    }
    ${
      trigger.autoTrigger
        ? `<span>è‡ªå‹•è§¸ç™¼ (æ¯ ${formatAutoInterval(
            trigger.autoInterval
          )})</span>`
        : ""
    }
    <button class="btn btn-danger" onclick="removeTrigger(${index})">åˆªé™¤</button>
</div>
`
          )
          .join("");
      }

      // æ ¼å¼åŒ–è‡ªå‹•è§¸ç™¼é–“éš”ç‚ºäººé¡å¯è®€æ ¼å¼
      function formatAutoInterval(interval) {
        if (!interval) return "";
        let parts = [];
        if (interval.hours > 0) parts.push(`${interval.hours} å°æ™‚`);
        if (interval.minutes > 0) parts.push(`${interval.minutes} åˆ†é˜`);
        if (interval.seconds > 0) parts.push(`${interval.seconds} ç§’`);
        return parts.length > 0 ? parts.join(" ") : "0 ç§’";
      }

      function removeTrigger(index) {
        currentTriggers.splice(index, 1);
        renderTriggers();
      }

      function renderTargetTags() {
        const tagBox = document.getElementById("trigger-targets-tags");
        tagBox.innerHTML = selectedTargets
          .map(
            (t) =>
              `<span class="tag" style="background:#e8f5e9;color:#388e3c;padding:2px 10px;border-radius:12px;font-size:0.95em;display:inline-flex;align-items:center;gap:4px;">${t.name}<span style="cursor:pointer;font-weight:bold;" onclick="removeTargetTag('${t.type}','${t.id}')">Ã—</span></span>`
          )
          .join("");
      }

      function removeTargetTag(type, id) {
        selectedTargets = selectedTargets.filter(
          (t) => !(t.type === type && t.id === id)
        );
        renderTargetTags();
      }

      document.getElementById("open-target-modal").onclick = function () {
        const modal = document.getElementById("target-modal");
        modal.style.display = "flex";

        // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        document.body.style.overflow = "hidden";

        renderTargetModal("group");
      };

      document.getElementById("modal-cancel").onclick = function () {
        document.getElementById("target-modal").style.display = "none";

        // æ¢å¾©èƒŒæ™¯æ»¾å‹•
        document.body.style.overflow = "";
      };

      document.getElementById("modal-confirm").onclick = function () {
        document.getElementById("target-modal").style.display = "none";

        // æ¢å¾©èƒŒæ™¯æ»¾å‹•
        document.body.style.overflow = "";

        renderTargetTags();
      };

      // ä¹Ÿç‚ºæ•´å€‹æ¨¡æ…‹çª—å£æ·»åŠ é»æ“Šäº‹ä»¶ï¼Œç•¶é»æ“ŠèƒŒæ™¯æ™‚é—œé–‰
      document
        .getElementById("target-modal")
        .addEventListener("click", function (event) {
          if (event.target === this) {
            this.style.display = "none";
            document.body.style.overflow = "";
          }
        });

      function renderTargetModal(tab) {
        // åˆå§‹é¡¯ç¤ºç‚ºç¾¤çµ„
        tab = tab || "group";

        const modalHeader = document.getElementById("modal-header");
        const modalList = document.getElementById("modal-list");
        const modalSelectedTags = document.getElementById(
          "modal-selected-tags"
        );
        const modalContent = document.querySelector(
          "#target-modal .modal-content"
        );

        // é˜»æ­¢æ»¾è¼ªäº‹ä»¶ç©¿é€
        if (!modalContent.hasAttribute("data-wheel-handler-added")) {
          modalContent.addEventListener("wheel", function (event) {
            event.stopPropagation();
          });
          modalContent.setAttribute("data-wheel-handler-added", "true");
        }

        // ä¿å­˜ç•¶å‰æœå°‹æ¡†çš„å€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const currentSearchValue = document.getElementById("target-search")
          ? document.getElementById("target-search").value
          : window.lastSearchValue || "";

        // æ¸²æŸ“æ¨™ç±¤å’Œæœå°‹æ¬„
        modalHeader.innerHTML = `
    <button id="tab-group" class="modal-tab ${
      tab === "group" ? "active" : ""
    }">ç¾¤çµ„</button>
    <button id="tab-contact" class="modal-tab ${
      tab === "contact" ? "active" : ""
    }">è¯çµ¡äºº</button>
    <input id="target-search" type="text" placeholder="æœå°‹åç¨±..." style="flex:1;padding:6px 10px;border-radius:4px;border:1px solid #ccc;" value="${currentSearchValue}" />
  `;

        // æ·»åŠ æ¨™ç±¤é»æ“Šäº‹ä»¶
        document.getElementById("tab-group").onclick = function () {
          renderTargetModal("group");
        };
        document.getElementById("tab-contact").onclick = function () {
          renderTargetModal("contact");
        };

        // æœå°‹åŠŸèƒ½ - åªæœ‰åœ¨è¼¸å…¥çµæŸå¾Œæ‰è§¸ç™¼éæ¿¾ï¼Œé¿å…å¯¦æ™‚æ¸²æŸ“å°è‡´çš„è¼¸å…¥å•é¡Œ
        const searchInput = document.getElementById("target-search");

        // ä½¿ç”¨ keyup äº‹ä»¶æ›¿ä»£ input äº‹ä»¶ï¼Œä¸¦æ·»åŠ å»¶é²è™•ç†
        searchInput.addEventListener(
          "keyup",
          debounce(function () {
            window.lastSearchValue = searchInput.value;
            filterItems(tab);
          }, 300)
        );

        // å¾è¼¸å…¥æ¢å¾©ç„¦é»å•é¡Œï¼ˆè®“ç”¨æˆ¶å¯ä»¥æŒçºŒè¼¸å…¥ï¼‰
        const focusPos = searchInput.value.length;
        searchInput.focus();
        searchInput.setSelectionRange(focusPos, focusPos);

        // åˆå§‹éæ¿¾é …ç›®
        filterItems(tab);

        // æ›´æ–°å·²é¸æ“‡çš„æ¨™ç±¤
        modalSelectedTags.innerHTML = selectedTargets.length
          ? selectedTargets
              .map(
                (t) =>
                  `<span class="tag" style="background:#e8f5e9;color:#388e3c;padding:2px 12px;border-radius:12px;font-size:0.97em;display:inline-flex;align-items:center;gap:4px;margin-right:4px;margin-bottom:4px;">${
                    t.name || t.id
                  }<span style="cursor:pointer;font-weight:bold;" onclick="removeTargetTag('${
                    t.type
                  }','${t.id}')">Ã—</span></span>`
              )
              .join("")
          : "";

        // å…§éƒ¨å‡½æ•¸ï¼šéæ¿¾é …ç›®ä¸¦æ›´æ–°åˆ—è¡¨
        function filterItems(tabType) {
          // æ ¹æ“šç•¶å‰æ¨™ç±¤é¸æ“‡é¡¯ç¤ºé …ç›®åˆ—è¡¨
          let items = tabType === "group" ? currentGroups : currentContacts;

          // å¦‚æœæœ‰æœå°‹æ–‡å­—å‰‡éæ¿¾
          const search = searchInput.value.trim().toLowerCase();
          if (search) {
            items = items.filter((item) =>
              (item.name || "").toLowerCase().includes(search)
            );
          }

          // ç”Ÿæˆé …ç›®åˆ—è¡¨ HTML
          modalList.innerHTML =
            items.length > 0
              ? items
                  .map((item) => {
                    const type = tabType;
                    const checked = selectedTargets.some(
                      (t) => t.type === type && t.id === item.id
                    );
                    return `<label style="display:flex;align-items:center;gap:8px;padding:10px 16px;cursor:pointer;border-bottom:1px solid #e0e0e0;">
                <input type="checkbox" ${
                  checked ? "checked" : ""
                } onchange="toggleTargetSelect('${type}','${item.id}','${
                      item.name ? item.name.replace(/'/g, "&#39;") : item.id
                    }')" />
                <span>${item.name || item.id}${
                      type === "contact" && item.number
                        ? ` (${item.number})`
                        : ""
                    }</span>
              </label>`;
                  })
                  .join("")
              : `<div style="padding:16px;color:#777;text-align:center;">æ²’æœ‰${
                  tabType === "group" ? "ç¾¤çµ„" : "è¯çµ¡äºº"
                }</div>`;
        }
      }

      // æ·»åŠ  debounce å‡½æ•¸ä¾†æ¸›å°‘æœå°‹è§¸ç™¼é »ç‡
      function debounce(func, wait) {
        let timeout;
        return function () {
          const context = this;
          const args = arguments;
          clearTimeout(timeout);
          timeout = setTimeout(function () {
            func.apply(context, args);
          }, wait);
        };
      }

      window.toggleTargetSelect = function (type, id, name) {
        const idx = selectedTargets.findIndex(
          (t) => t.type === type && t.id === id
        );
        if (idx >= 0) {
          selectedTargets.splice(idx, 1);
        } else {
          selectedTargets.push({ type, id, name });
        }
        document.getElementById("modal-selected-tags").innerHTML =
          selectedTargets.length
            ? selectedTargets
                .map(
                  (t) =>
                    `<span class="tag">${t.name}<span style="cursor:pointer;font-weight:bold;margin-left:4px;" onclick="removeTargetTag('${t.type}','${t.id}')">Ã—</span></span>`
                )
                .join("")
            : "";
      };

      window.removeTargetTag = function (type, id) {
        selectedTargets = selectedTargets.filter(
          (t) => !(t.type === type && t.id === id)
        );
        renderTargetTags();
        // å¦‚æœæ¨¡æ…‹çª—å£æ˜¯é–‹è‘—çš„ï¼Œä¹Ÿæ›´æ–°å®ƒçš„æ¨™ç±¤
        if (document.getElementById("target-modal").style.display === "flex") {
          document.getElementById("modal-selected-tags").innerHTML =
            selectedTargets.length
              ? selectedTargets
                  .map(
                    (t) =>
                      `<span class="tag">${t.name}<span style="cursor:pointer;font-weight:bold;margin-left:4px;" onclick="removeTargetTag('${t.type}','${t.id}')">Ã—</span></span>`
                  )
                  .join("")
              : "";
        }
      };

      function editCommand(id) {
        const command = currentCommands.find((cmd) => cmd.id === id);
        if (!command) return;
        // å¡«å…¥è§¸ç™¼æ¢ä»¶
        currentTriggers = command.triggers.map((t) => ({ ...t }));
        renderTriggers();
        // å¡«å…¥å›æ‡‰é¡å‹
        document.getElementById("response-type").value = command.response.type;
        // è§¸ç™¼å›æ‡‰é¡å‹åˆ‡æ›äº‹ä»¶ï¼Œç¢ºä¿ CodeMirror æ­£ç¢ºåˆå§‹åŒ–
        const event = new Event("change");
        document.getElementById("response-type").dispatchEvent(event);
        // å¡«å…¥å›æ‡‰å…§å®¹
        setTimeout(async () => {
          if (command.response.type === "function" && codeMirrorEditor) {
            try {
              const res = await fetch(
                `/data/functions/${command.id}.js?_=${Date.now()}`
              );
              if (res.ok) {
                let jsText = await res.text();
                // ç§»é™¤ module.exports = async function(msg) { ... }
                jsText = jsText.replace(
                  /^module\.exports\s*=\s*async function\s*\(msg\)\s*{([\s\S]*)}$/m,
                  (m, body) =>
                    body
                      .trim()
                      .replace(/\n}$/, "")
                      .replace(/^\s*|\s*$/g, "")
                );
                codeMirrorEditor.setValue(jsText.trim());
              } else {
                codeMirrorEditor.setValue(command.response.content || "");
              }
            } catch (e) {
              codeMirrorEditor.setValue(command.response.content || "");
            }
          } else {
            document.getElementById("response-content").value =
              command.response.content;
          }
        }, 0);
        document.getElementById("response-file").value = "";
        // å¡«å…¥è§¸ç™¼åå–®
        selectedTargets = command.targets.map((t) => {
          let name = "";
          if (t.type === "group") {
            const g = currentGroups.find((g) => g.id === t.id);
            name = g ? g.name : t.id;
          } else if (t.type === "contact") {
            const c = currentContacts.find((c) => c.id === t.id);
            name = c ? c.name : t.id;
          }
          return { ...t, name };
        });
        renderTargetTags();
        // è¨­å®šç·¨è¼¯ç‹€æ…‹
        editingCommandId = id;
        // åˆ‡æ›å„²å­˜æŒ‰éˆ•æ–‡å­—
        const saveBtn = document.querySelector("#commands .btn.btn-primary");
        if (saveBtn) saveBtn.textContent = "æ›´æ–°æŒ‡ä»¤";
      }

      async function saveCommand() {
        const responseType = document.getElementById("response-type").value;
        let responseContent = document.getElementById("response-content").value;
        if (responseType === "function" && codeMirrorEditor) {
          try {
            // ä½¿ç”¨ prettier è€Œéä¸å­˜åœ¨çš„ autoFormatRange æ–¹æ³•æ ¼å¼åŒ–ç¨‹å¼ç¢¼
            const code = codeMirrorEditor.getValue();

            // ä½¿ç”¨ prettier æ ¼å¼åŒ–
            const formattedCode = prettier.format(code, {
              parser: "babel",
              plugins: [prettierPlugins.babel],
              semi: true,
              singleQuote: false,
              tabWidth: 2,
              printWidth: 80,
            });

            // æ›´æ–°ç·¨è¼¯å™¨å…§å®¹
            codeMirrorEditor.setValue(formattedCode);

            // ç²å–æ ¼å¼åŒ–å¾Œçš„å…§å®¹
            responseContent = codeMirrorEditor.getValue();
          } catch (err) {
            console.error("æ ¼å¼åŒ–ä»£ç¢¼å¤±æ•—:", err);
            // æ ¼å¼åŒ–å¤±æ•—æ™‚ä»ç„¶ä½¿ç”¨åŸå§‹ä»£ç¢¼
            responseContent = codeMirrorEditor.getValue();
          }
        }
        const fileInput = document.getElementById("response-file");

        // ç¢ºèªè‡³å°‘æœ‰ä¸€å€‹è§¸ç™¼æ¢ä»¶
        if (currentTriggers.length === 0) {
          alert("è«‹è‡³å°‘æ·»åŠ ä¸€å€‹è§¸ç™¼æ¢ä»¶");
          return;
        }

        // æª¢æŸ¥æ¯å€‹è§¸ç™¼æ¢ä»¶æ˜¯å¦æœ‰æ•ˆ
        let hasValidTrigger = false;
        for (let trigger of currentTriggers) {
          // å¦‚æœæ˜¯è¡¨æƒ…åæ‡‰ï¼Œå¿…é ˆé¸æ“‡ä¸€å€‹è¡¨æƒ…ç¬¦è™Ÿ
          if (trigger.hasReaction) {
            if (!trigger.reaction || trigger.reaction === "ç„¡") {
              alert("æœ‰è¡¨æƒ…åæ‡‰çš„è§¸ç™¼æ¢ä»¶å¿…é ˆé¸æ“‡ä¸€å€‹è¡¨æƒ…ç¬¦è™Ÿ");
              return;
            }
            hasValidTrigger = true;
          }
          // å¦‚æœæ˜¯å…¶ä»–é¡å‹çš„è§¸ç™¼æ¢ä»¶
          else if (
            trigger.keyword ||
            trigger.quotedMsg ||
            trigger.hasMedia ||
            trigger.timeRange ||
            trigger.autoTrigger
          ) {
            hasValidTrigger = true;
          }
        }

        // ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹æœ‰æ•ˆçš„è§¸ç™¼æ¢ä»¶
        if (!hasValidTrigger) {
          alert("è«‹ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹æœ‰æ•ˆçš„è§¸ç™¼æ¢ä»¶");
          return;
        }

        if (
          (responseType === "text" ||
            responseType === "code" ||
            responseType === "function") &&
          !responseContent
        ) {
          alert("è«‹è¼¸å…¥å›æ‡‰å…§å®¹");
          return;
        }
        if (
          (responseType === "image" || responseType === "video") &&
          fileInput.files.length === 0 &&
          !editingCommandId
        ) {
          alert("è«‹ä¸Šå‚³åª’é«”æ–‡ä»¶");
          return;
        }
        if (
          (responseType === "image" || responseType === "video") &&
          fileInput.files.length > 0
        ) {
          const file = fileInput.files[0];
          if (responseType === "video" && file.size > 16 * 1024 * 1024) {
            alert("å½±ç‰‡æª”æ¡ˆè¶…é 16MBï¼Œè«‹å…ˆå£“ç¸®å¾Œå†ä¸Šå‚³ã€‚");
            return;
          }
        }
        let content = responseContent;
        if (
          (responseType === "image" || responseType === "video") &&
          fileInput.files.length > 0
        ) {
          // Read file as base64
          const file = fileInput.files[0];
          content = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }
        const commandData = {
          id: editingCommandId || Date.now().toString(),
          triggers: currentTriggers,
          response: {
            type: responseType,
            content: content,
          },
          targets: selectedTargets,
        };
        try {
          const url = editingCommandId
            ? `/api/commands/${editingCommandId}`
            : "/api/commands";
          const method = editingCommandId ? "PUT" : "POST";
          const response = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(commandData),
          });
          if (response.ok) {
            // æ¸…ç©ºè¡¨å–®
            if (responseType === "function" && codeMirrorEditor) {
              codeMirrorEditor.setValue(""); // æ¸…ç©º CodeMirror ç·¨è¼¯å™¨
            } else {
              document.getElementById("response-content").value = ""; // æ¸…ç©ºä¸€èˆ¬æ–‡å­—è¼¸å…¥æ¡†
            }
            fileInput.value = "";
            currentTriggers = [];
            renderTriggers();
            selectedTargets = [];
            renderTargetTags();
            editingCommandId = null;
            // æ¢å¾©å„²å­˜æŒ‰éˆ•æ–‡å­—
            const saveBtn = document.querySelector(
              "#commands .btn.btn-primary"
            );
            if (saveBtn) saveBtn.textContent = "å„²å­˜æŒ‡ä»¤";
            // æ¸…ç©ºæŒ‡ä»¤ç·¨è¼¯å€å…§å®¹
            document.getElementById("response-type").value = "text";
            document
              .getElementById("response-type")
              .dispatchEvent(new Event("change"));
            await initializeData();
            alert("æŒ‡ä»¤å„²å­˜æˆåŠŸ");
          } else {
            const errorData = await response.json();
            alert(
              errorData.message ||
                (editingCommandId ? "æ›´æ–°æŒ‡ä»¤å¤±æ•—" : "ä¿å­˜æŒ‡ä»¤å¤±æ•—")
            );
          }
        } catch (error) {
          console.error("Error saving command:", error);
          alert(editingCommandId ? "æ›´æ–°æŒ‡ä»¤å¤±æ•—" : "ä¿å­˜æŒ‡ä»¤å¤±æ•—");
        }
      }

      function renderCommands() {
        const container = document.getElementById("commands-list");
        container.innerHTML = currentCommands
          .map(
            (command) => `
        <div class="list-item">
            <div>
                <strong>è§¸ç™¼æ¢ä»¶ï¼š</strong>
                <ul style="list-style-type: disc; margin-left: 20px; padding-left: 0;">
                    ${command.triggers
                      .map((t) => {
                        let triggerDesc = [];
                        if (t.keyword) {
                          triggerDesc.push(
                            `é—œéµè©: "${t.keyword}"${
                              t.isRegex ? " (æ­£å‰‡)" : ""
                            }`
                          );
                        }
                        if (t.quotedMsg) {
                          triggerDesc.push("å¼•ç”¨è¨Šæ¯");
                        }
                        if (t.hasMedia) {
                          triggerDesc.push("åŒ…å«åœ–ç‰‡/åª’é«”");
                        }
                        if (t.hasReaction) {
                          triggerDesc.push(`è¡¨æƒ…åæ‡‰: ${t.reaction}`);
                        }
                        if (t.timeRange) {
                          triggerDesc.push(
                            `ç‰¹å®šæ™‚æ®µ: ${t.startTime} - ${t.endTime}`
                          );
                        }
                        if (t.autoTrigger && t.autoInterval) {
                          const interval = t.autoInterval;
                          let intervalParts = [];
                          if (interval.hours > 0)
                            intervalParts.push(`${interval.hours}å°æ™‚`);
                          if (interval.minutes > 0)
                            intervalParts.push(`${interval.minutes}åˆ†é˜`);
                          if (interval.seconds > 0)
                            intervalParts.push(`${interval.seconds}ç§’`);
                          triggerDesc.push(
                            `è‡ªå‹•è§¸ç™¼ (æ¯ ${intervalParts.join(" ") || "0ç§’"})`
                          );
                        }

                        let modifiers = [];
                        if (t.toLowerCase) modifiers.push("å¿½ç•¥å¤§å°å¯«");
                        if (t.startsWith) modifiers.push("é–‹é ­åŒ¹é…");
                        if (modifiers.length > 0) {
                          triggerDesc.push(`(${modifiers.join(", ")})`);
                        }

                        return `<li>${
                          triggerDesc.join(", ") || "æœªè¨­å®šä»»ä½•æ¢ä»¶"
                        }</li>`;
                      })
                      .join("")}
                </ul>
                <div class="text-gray-500" style="margin-top: 4px;">
                    <strong>å›æ‡‰é¡å‹ï¼š</strong>${command.response.type}
                </div>
                <div class="text-gray-500">
                    <strong>è§¸ç™¼å°è±¡ï¼š</strong>${command.targets.length} å€‹
                </div>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-primary" onclick="editCommand('${
                command.id
              }')">ç·¨è¼¯</button>
              <button class="btn btn-danger" onclick="deleteCommand('${
                command.id
              }')">åˆªé™¤</button>
            </div>
        </div>
    `
          )
          .join("");
      }

      async function deleteCommand(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æŒ‡ä»¤å—ï¼Ÿ")) return;

        try {
          const response = await fetch(`/api/commands/${id}`, {
            method: "DELETE",
          });

          if (response.ok) {
            await initializeData();
          }
        } catch (error) {
          console.error("Error deleting command:", error);
          alert("åˆªé™¤æŒ‡ä»¤å¤±æ•—");
        }
      }

      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", () => {
          if (item.dataset.section === "commands") {
            renderTargetTags();
          }
          if (item.dataset.section !== "commands") {
            cleanupCommandsSection();
          }
        });
      });

      // åœ¨ HTML åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–æ•¸æ“š
      document.addEventListener("DOMContentLoaded", () => {
        initializeData();

        // Fetch bot status from /health API and update UI
        fetch("/health")
          .then((response) => response.json())
          .then((data) => {
            const botStatusElem = document.getElementById("bot-status");
            const toggleBtn = document.getElementById("toggle-bot");
            if (data.bot && data.bot.initialized) {
              botStatusElem.textContent = "å·²é€£æ¥";
              botStatusElem.className = "status online";
              toggleBtn.textContent = "é—œé–‰ Bot";
              isConnected = true;
            } else {
              botStatusElem.textContent = "é›¢ç·š";
              botStatusElem.className = "status offline";
              toggleBtn.textContent = "å•Ÿå‹• Bot";
              isConnected = false;
            }
          })
          .catch((error) => {
            console.error("Error fetching bot status:", error);
          });

        // æ·»åŠ è§¸ç™¼æ¢ä»¶å®¹å™¨
        const triggerConditions = document.querySelector("#trigger-conditions");
        triggerConditions.insertAdjacentHTML(
          "beforeend",
          '<div id="current-triggers"></div>'
        );

        // Override console methods to capture logs
        const consoleLogs = document.getElementById("console-logs");
        ["log", "error", "warn", "info"].forEach((method) => {
          const original = console[method];
          console[method] = function (...args) {
            original.apply(console, args);
            const message = args
              .map((arg) =>
                typeof arg === "object" ? JSON.stringify(arg) : String(arg)
              )
              .join(" ");
            const logEntry = document.createElement("div");
            logEntry.textContent = `[${method.toUpperCase()}] ${message}`;
            consoleLogs.appendChild(logEntry);
            consoleLogs.scrollTop = consoleLogs.scrollHeight;
          };
        });

        // Terminal form submission
        const terminalForm = document.getElementById("terminal-form");
        const terminalInput = document.getElementById("terminal-input");
        const terminalOutput = document.getElementById("terminal-output");
        if (terminalForm) {
          terminalForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const cmd = terminalInput.value.trim();
            if (!cmd) return;
            terminalOutput.textContent = "åŸ·è¡Œä¸­...";
            try {
              const res = await fetch("/api/terminal", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ command: cmd }),
              });
              const data = await res.json();
              terminalOutput.textContent =
                data.output || data.error || "(ç„¡è¼¸å‡º)";
            } catch (err) {
              terminalOutput.textContent = "åŸ·è¡Œå¤±æ•—ï¼š" + err.message;
            }
          });
        }

        // ä¸­è‹±æ–‡åˆ‡æ›ï¼ˆç”¨ Material Icons translate åœ–ç¤ºï¼‰
        let currentLang = "zh";
        const translations = {
          zh: {
            "nav-title": "WhatsApp Bot",
            "nav-home": "é¦–é ",
            "nav-groups": "ç¾¤çµ„",
            "nav-contacts": "å€‹äºº",
            "nav-commands": "æŒ‡ä»¤",
            "nav-console": "ç³»çµ±æ—¥èªŒ",
            "home-title": "Bot æ§åˆ¶å°",
            "status-online": "å·²é€£æ¥",
            "status-offline": "é›¢ç·š",
            "bot-start": "å•Ÿå‹• Bot",
            "bot-stop": "é—œé–‰ Bot",
            "groups-title": "ç¾¤çµ„ç®¡ç†",
            "group-name-placeholder": "ç¾¤çµ„åç¨±",
            "group-search-btn": "æœå°‹ä¸¦æ·»åŠ ç¾¤çµ„",
            "contacts-title": "å€‹äººè¯çµ¡äººç®¡ç†",
            "contact-prefix-placeholder": "åœ‹ç¢¼ (ä¾‹: 852)",
            "contact-number-placeholder": "é›»è©±è™Ÿç¢¼",
            "contact-name-placeholder": "å‚™è¨»åç¨±",
            "contact-add-btn": "æ–°å¢è¯çµ¡äºº",
            "commands-title": "æŒ‡ä»¤ç®¡ç†",
            "trigger-label": "è§¸ç™¼æ¢ä»¶",
            "trigger-keyword-placeholder": "æ–°å¢é—œéµè©",
            "ignore-case": "å¿½ç•¥å¤§å°å¯«",
            "match-start": "é–‹é ­åŒ¹é…",
            "add-trigger-btn": "æ–°å¢è§¸ç™¼æ¢ä»¶",
            "response-type-label": "å›æ‡‰é¡å‹",
            "response-content-placeholder": "å›æ‡‰å…§å®¹",
            "save-command-btn": "å„²å­˜æŒ‡ä»¤",
            "update-command-btn": "æ›´æ–°æŒ‡ä»¤",
            "delete-btn": "åˆªé™¤",
            "edit-btn": "ç·¨è¼¯",
            "console-title": "ç³»çµ±æ—¥èªŒ",
            "clear-logs-btn": "æ¸…é™¤æ—¥èªŒ",
            "export-logs-btn": "å°å‡ºæ—¥èªŒ",
            "terminal-title": "ç®¡ç†å“¡ Terminalï¼ˆåƒ…é™ npm install æŒ‡ä»¤ï¼‰",
            "terminal-placeholder": "ä¾‹å¦‚ï¼šnpm i axios",
            "execute-btn": "åŸ·è¡Œ",
          },
          en: {
            "nav-title": "WhatsApp Bot",
            "nav-home": "Home",
            "nav-groups": "Groups",
            "nav-contacts": "Contacts",
            "nav-commands": "Commands",
            "nav-console": "Console",
            "home-title": "Bot Control Panel",
            "status-online": "Connected",
            "status-offline": "Offline",
            "bot-start": "Start Bot",
            "bot-stop": "Stop Bot",
            "groups-title": "Groups Management",
            "group-name-placeholder": "Group Name",
            "group-search-btn": "Search & Add Group",
            "contacts-title": "Contacts Management",
            "contact-prefix-placeholder": "Country Code (e.g. 852)",
            "contact-number-placeholder": "Phone Number",
            "contact-name-placeholder": "Display Name",
            "contact-add-btn": "Add Contact",
            "commands-title": "Commands Management",
            "trigger-label": "Trigger Conditions",
            "trigger-keyword-placeholder": "Add Keyword",
            "ignore-case": "Ignore Case",
            "match-start": "Match Start",
            "add-trigger-btn": "Add Trigger",
            "response-type-label": "Response Type",
            "response-content-placeholder": "Response Content",
            "save-command-btn": "Save Command",
            "update-command-btn": "Update Command",
            "delete-btn": "Delete",
            "edit-btn": "Edit",
            "console-title": "System Logs",
            "clear-logs-btn": "Clear Logs",
            "export-logs-btn": "Export Logs",
            "terminal-title": "Admin Terminal (npm install only)",
            "terminal-placeholder": "e.g. npm i axios",
            "execute-btn": "Execute",
          },
        };

        // ç¯„æœ¬æŒ‰éˆ•é»æ“Šäº‹ä»¶
        document
          .getElementById("template-btn")
          .addEventListener("click", function () {
            document.getElementById("template-modal").style.display = "flex";
          });

        // é—œé–‰æ¨¡æ…‹çª—å£
        document
          .querySelector("#template-modal .close-btn")
          .addEventListener("click", function () {
            document.getElementById("template-modal").style.display = "none";
          });

        // å–æ¶ˆæŒ‰éˆ•é»æ“Šäº‹ä»¶
        document
          .getElementById("modal-template-cancel")
          .addEventListener("click", function () {
            document.getElementById("template-modal").style.display = "none";
          });

        // ç¢ºèªæŒ‰éˆ•é»æ“Šäº‹ä»¶
        document
          .getElementById("modal-template-confirm")
          .addEventListener("click", function () {
            // ç²å–ç”¨æˆ¶å¡«å¯«çš„å¿…è¦åƒæ•¸
            const apiKey = document
              .getElementById("openrouter_api_key")
              .value.trim();
            const model = document.getElementById("model").value.trim();
            const apiUrl = document.getElementById("api_url").value.trim();
            const defaultSystemPrompt = document
              .getElementById("default_system_prompt")
              .value.trim();
            const userSystemPromptsFormat = document
              .getElementById("user_system_prompts_format")
              .value.trim();

            // æª¢æŸ¥å¿…å¡«å­—æ®µ
            if (!apiKey || !model || !apiUrl) {
              alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆæ¨™æœ‰ * çš„æ¬„ä½ï¼‰");
              return;
            }

            // ç²å– AI ç¯„æœ¬ä»£ç¢¼ä¸¦é€²è¡Œæ›¿æ›
            fetch(
              "https://raw.githubusercontent.com/SoRcKwYo/wsbot/main/lib/ai.js"
            )
              .then((response) => response.text())
              .then((code) => {
                // æ›¿æ›é—œéµè®Šæ•¸
                let templateCode = code
                  .replace(
                    /OPENROUTER_API_KEY\s*=\s*"[^"]*"/,
                    `OPENROUTER_API_KEY = "${apiKey}"`
                  )
                  .replace(/MODEL\s*=\s*"[^"]*"/, `MODEL = "${model}"`)
                  .replace(/API_URL\s*=\s*"[^"]*"/, `API_URL = "${apiUrl}"`)
                  .replace(
                    /const defaultSystemPrompt\s*=\s*"[^"]*"/,
                    `const defaultSystemPrompt = "${defaultSystemPrompt}"`
                  )
                  .replace(
                    /const userSystemPrompts\s*=\s*\{\}/,
                    `const userSystemPrompts = ${
                      userSystemPromptsFormat
                        ? "{/* " + userSystemPromptsFormat + " */}"
                        : "{}"
                    }`
                  );

                // æå–å‡½æ•¸é«”éƒ¨åˆ†ä¸¦è¨­ç½®åˆ° CodeMirror ç·¨è¼¯å™¨
                if (codeMirrorEditor) {
                  codeMirrorEditor.setValue(templateCode);
                } else {
                  document.getElementById("response-content").value =
                    templateCode;
                }

                // é—œé–‰æ¨¡æ…‹çª—å£
                document.getElementById("template-modal").style.display =
                  "none";
              })
              .catch((error) => {
                console.error("ç²å–ç¯„æœ¬å¤±æ•—:", error);
                alert("ç²å–ç¯„æœ¬å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥");
              });
          });

        function updatePageLanguage() {
          const t = translations[currentLang];

          // Update nav
          document.querySelector(".nav-logo h2").textContent = t["nav-title"];
          document.querySelector('[data-section="home"]').textContent =
            t["nav-home"];
          document.querySelector('[data-section="groups"]').textContent =
            t["nav-groups"];
          document.querySelector('[data-section="contacts"]').textContent =
            t["nav-contacts"];
          document.querySelector('[data-section="commands"]').textContent =
            t["nav-commands"];
          document.querySelector('[data-section="console"]').textContent =
            t["nav-console"];

          // Update sections
          document.querySelector("#home h2").textContent = t["home-title"];
          document.querySelector("#groups h2").textContent = t["groups-title"];
          document.querySelector("#contacts h2").textContent =
            t["contacts-title"];
          document.querySelector("#commands h2").textContent =
            t["commands-title"];
          document.querySelector("#console h2").textContent =
            t["console-title"];

          // Update placeholders
          document.querySelector("#group-name").placeholder =
            t["group-name-placeholder"];
          document.querySelector("#contact-prefix").placeholder =
            t["contact-prefix-placeholder"];
          document.querySelector("#contact-number").placeholder =
            t["contact-number-placeholder"];
          document.querySelector("#contact-name").placeholder =
            t["contact-name-placeholder"];

          // Update buttons
          document.querySelector("#toggle-bot").textContent = isConnected
            ? t["bot-stop"]
            : t["bot-start"];
          document
            .querySelectorAll(".btn-danger")
            .forEach((btn) => (btn.textContent = t["delete-btn"]));

          // Update status text
          if (
            document.querySelector("#bot-status").classList.contains("online")
          ) {
            document.querySelector("#bot-status").textContent =
              t["status-online"];
          } else {
            document.querySelector("#bot-status").textContent =
              t["status-offline"];
          }

          // Update terminal section
          document.querySelector("#terminal-section h3").textContent =
            t["terminal-title"];
          document.querySelector("#terminal-input").placeholder =
            t["terminal-placeholder"];
          document.querySelector("#terminal-form button").textContent =
            t["execute-btn"];
        }

        document.getElementById("lang-toggle").onclick = function () {
          currentLang = currentLang === "zh" ? "en" : "zh";
          document.getElementById("lang-icon").src =
            "https://fonts.gstatic.com/s/i/materialicons/translate/v1/24px.svg";
          updatePageLanguage();
        };

        // æ·±æ·ºè‰²æ¨¡å¼åˆ‡æ›
        let isDark = localStorage.getItem("theme") === "dark";
        const root = document.documentElement;
        if (isDark) {
          root.setAttribute("data-theme", "dark");
          document.getElementById("theme-icon").src =
            "https://fonts.gstatic.com/s/i/materialicons/light_mode/v1/24px.svg";
          document.getElementById("theme-toggle").style.background = "#333";
        } else {
          root.removeAttribute("data-theme");
          document.getElementById("theme-icon").src =
            "https://fonts.gstatic.com/s/i/materialicons/dark_mode/v1/24px.svg";
          document.getElementById("theme-toggle").style.background = "#fff";
        }

        document
          .getElementById("theme-toggle")
          .addEventListener("click", function () {
            isDark = !isDark;
            if (isDark) {
              root.setAttribute("data-theme", "dark");
              document.getElementById("theme-icon").src =
                "https://fonts.gstatic.com/s/i/materialicons/light_mode/v1/24px.svg";
              document.getElementById("theme-icon").style.filter = "invert(1)";
              document.getElementById("theme-toggle").style.background = "#333";
              localStorage.setItem("theme", "dark");
            } else {
              root.removeAttribute("data-theme");
              document.getElementById("theme-icon").src =
                "https://fonts.gstatic.com/s/i/materialicons/dark_mode/v1/24px.svg";
              document.getElementById("theme-icon").style.filter = "";
              document.getElementById("theme-toggle").style.background = "#fff";
              localStorage.setItem("theme", "light");
            }
          });

        // ä¸‹è¼‰/æ›´æ–° HTML ä¸¦ F5
        const updateBtn = document.getElementById("update-html-btn");
        // åªåœ¨æŒ‰éˆ•ä¸æ˜¯ç¦ç”¨/åŠ è¼‰ç‹€æ…‹æ™‚æ›´æ–°å…¶æ–‡æœ¬
        if (!updateBtn.disabled) {
          updateBtn.innerHTML = `<img src="https://fonts.gstatic.com/s/i/materialicons/refresh/v1/24px.svg" alt="Update" style="width: 22px; height: 22px; filter: invert(1)" />`;
        }
        updateBtn.onclick = async function () {
          updateBtn.disabled = true;
          updateBtn.textContent =
            currentLang === "zh" ? "ä¸‹è¼‰ä¸­..." : "Updating...";
          try {
            const res = await fetch("/api/update-html", { method: "POST" });
            const data = await res.json();
            if (data.success) {
              updateBtn.textContent =
                currentLang === "zh"
                  ? "å®Œæˆï¼Œé‡æ–°æ•´ç†ä¸­..."
                  : "Done, refreshing...";
              setTimeout(() => location.reload(), 1200);
            } else {
              updateBtn.textContent = data.error || "å¤±æ•—";
              setTimeout(() => {
                updateBtn.textContent =
                  currentLang === "zh"
                    ? "ä¸‹è¼‰/æ›´æ–° HTML ä¸¦é‡æ–°æ•´ç†"
                    : "Update HTML & Refresh";
                updateBtn.disabled = false;
              }, 2000);
            }
          } catch (e) {
            updateBtn.textContent = "éŒ¯èª¤";
            setTimeout(() => {
              updateBtn.textContent =
                currentLang === "zh"
                  ? "ä¸‹è¼‰/æ›´æ–° HTML ä¸¦é‡æ–°æ•´ç†"
                  : "Update HTML & Refresh";
              updateBtn.disabled = false;
            }, 2000);
          }
        };
      });

      // Initial load
      updateToggleButton();

      const autoTriggerCheckbox = document.querySelector(
        'input[name="autoTrigger"]'
      );
      const autoTriggerSelector = document.getElementById(
        "auto-trigger-selector"
      );

      if (autoTriggerCheckbox && autoTriggerSelector) {
        autoTriggerCheckbox.addEventListener("change", function () {
          autoTriggerSelector.style.display = this.checked ? "block" : "none";
        });
      }

      // ç‰ˆæœ¬æª¢æ¸¬åŠŸèƒ½
      let currentVersionSha = "";
      let updateCheckInterval;

      // åˆå§‹åŒ–ç‰ˆæœ¬é¡¯ç¤º
      async function initVersion() {
        try {
          // ç²å–æœ¬åœ°ç‰ˆæœ¬è™Ÿ
          const localPath = window.location.pathname;
          const localTimestamp = new Date().toISOString().split("T")[0];
          const versionElement = document.getElementById("version-number");

          // è¨­ç½®åˆå§‹ç‰ˆæœ¬é¡¯ç¤º
          versionElement.textContent = `v${localTimestamp}`;
          currentVersionSha = localTimestamp;

          // å¾ä¼ºæœå™¨ç²å–æ›´ç²¾ç¢ºçš„ç‰ˆæœ¬è³‡è¨Š
          const response = await fetch("/api/check-update");

          if (response.ok) {
            const data = await response.json();
            if (data.latestCommitSha) {
              // æ›´æ–°ç‚º commit SHA çš„çŸ­ç‰ˆæœ¬
              currentVersionSha = data.latestCommitSha;
              versionElement.textContent = `v${currentVersionSha}`;
            }
          }

          // é–‹å§‹å®šæœŸæª¢æŸ¥æ›´æ–°
          startVersionCheck();
        } catch (error) {
          console.error("åˆå§‹åŒ–ç‰ˆæœ¬è™Ÿå¤±æ•—:", error);
        }
      }

      // é–‹å§‹å®šæœŸæª¢æŸ¥æ›´æ–°
      function startVersionCheck() {
        // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„èˆŠå®šæ™‚å™¨
        if (updateCheckInterval) {
          clearInterval(updateCheckInterval);
        }

        // è¨­å®šæ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
        updateCheckInterval = setInterval(checkUpdate, 3600000);

        // ç«‹å³åŸ·è¡Œä¸€æ¬¡æª¢æŸ¥
        checkUpdate();
      }

      // æª¢æŸ¥æ˜¯å¦æœ‰æ›´æ–°
      async function checkUpdate() {
        try {
          const response = await fetch("/api/check-update");

          if (!response.ok) {
            throw new Error(`æª¢æŸ¥æ›´æ–°å¤±æ•—: ${response.status}`);
          }

          const data = await response.json();
          const versionElement = document.getElementById("version-number");

          if (data.hasUpdate) {
            // æœ‰æ›´æ–°æ™‚åœ¨ç‰ˆæœ¬è™Ÿå¾Œæ·»åŠ  "!" è™Ÿ
            if (!versionElement.textContent.includes("!")) {
              versionElement.textContent = `v${currentVersionSha} !`;
              versionElement.style.color = "var(--error)";
              versionElement.style.fontWeight = "700";

              // éœ‡å‹•å‹•ç•«æ•ˆæœ
              versionElement.style.animation = "version-shake 0.5s ease";
              // å®šç¾©éœ‡å‹•å‹•ç•«
              const style = document.createElement("style");
              style.textContent = `
          @keyframes version-shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-3px); }
            40%, 80% { transform: translateX(3px); }
          }
        `;
              document.head.appendChild(style);
            }
          } else {
            // æ²’æœ‰æ›´æ–°æ™‚æ¢å¾©æ­£å¸¸é¡¯ç¤º
            if (versionElement.textContent.includes("!")) {
              versionElement.textContent = `v${currentVersionSha}`;
              versionElement.style.color = "var(--text-secondary)";
              versionElement.style.fontWeight = "500";
              versionElement.style.animation = "";
            }
          }
        } catch (error) {
          console.error("æª¢æŸ¥æ›´æ–°å¤±æ•—:", error);
        }
      }

      // ç•¶DOMåŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–ç‰ˆæœ¬é¡¯ç¤º
      document.addEventListener("DOMContentLoaded", () => {
        // å…¶ä»–ç¾æœ‰çš„ DOMContentLoaded äº‹ä»¶è™•ç†...

        // åˆå§‹åŒ–ç‰ˆæœ¬é¡¯ç¤º
        initVersion();

        // æ·»åŠ æ›´æ–°æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼šæ›´æ–°å¾Œé‡ç½®ç‰ˆæœ¬ç‹€æ…‹
        const updateBtn = document.getElementById("update-html-btn");
        const originalClickHandler = updateBtn.onclick;
        updateBtn.onclick = async function (event) {
          if (originalClickHandler) {
            await originalClickHandler.call(this, event);
          }

          // æ›´æ–°æˆåŠŸå¾Œé‡ç½®ç‰ˆæœ¬æª¢æŸ¥
          setTimeout(() => {
            const versionElement = document.getElementById("version-number");
            versionElement.textContent = `v${currentVersionSha}`;
            versionElement.style.color = "var(--text-secondary)";
            versionElement.style.fontWeight = "500";
          }, 500);
        };
      });
    </script>
  </body>
</html>
